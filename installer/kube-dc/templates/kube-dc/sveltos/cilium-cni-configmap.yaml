apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    projectsveltos.io/template: "true"
  name: cilium-cni-template
  namespace: projectsveltos
data:
  cilium.yaml: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: cilium
      namespace: kube-system
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: cilium-operator
      namespace: kube-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: cilium
    rules:
    - apiGroups:
      - networking.k8s.io
      resources:
      - networkpolicies
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - discovery.k8s.io
      resources:
      - endpointslices
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ''
      resources:
      - configmaps
      - namespaces
      - services
      - pods
      - pods/finalizers
      - endpoints
      - nodes
      - nodes/status
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ''
      resources:
      - pods
      - pods/status
      - pods/finalizers
      verbs:
      - update
      - patch
    - apiGroups:
      - ''
      resources:
      - nodes
      - nodes/status
      verbs:
      - patch
    - apiGroups:
      - apiextensions.k8s.io
      resources:
      - customresourcedefinitions
      verbs:
      - list
      - watch
      - get
    - apiGroups:
      - cilium.io
      resources:
      - '*'
      verbs:
      - '*'
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: cilium-operator
    rules:
    - apiGroups:
      - ''
      resources:
      - namespaces
      - pods
      verbs:
      - get
      - list
      - watch
      - delete
    - apiGroups:
      - ''
      resources:
      - nodes
      - services
      - endpoints
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - cilium.io
      resources:
      - '*'
      verbs:
      - '*'
    - apiGroups:
      - apiextensions.k8s.io
      resources:
      - customresourcedefinitions
      verbs:
      - create
      - get
      - list
      - watch
    - apiGroups:
      - coordination.k8s.io
      resources:
      - leases
      verbs:
      - create
      - get
      - update
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: cilium
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: cilium
    subjects:
    - kind: ServiceAccount
      name: cilium
      namespace: kube-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: cilium-operator
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: cilium-operator
    subjects:
    - kind: ServiceAccount
      name: cilium-operator
      namespace: kube-system
    ---
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: cilium-config
      namespace: kube-system
    data:
      debug: 'false'
      enable-policy: default
      enable-ipv4: 'true'
      enable-ipv6: 'false'
      custom-cni-conf: 'false'
      enable-bpf-clock-probe: 'true'
      monitor-aggregation: medium
      monitor-aggregation-interval: 5s
      monitor-aggregation-flags: all
      bpf-policy-map-max: '16384'
      bpf-map-dynamic-size-ratio: '0.0025'
      preallocate-bpf-maps: 'false'
      tunnel: vxlan
      cluster-name: default
      wait-bpf-mount: 'false'
      enable-endpoint-health-checking: 'true'
      enable-health-checking: 'true'
      enable-well-known-identities: 'false'
      enable-remote-node-identity: 'true'
      operator-api-serve-addr: 127.0.0.1:9234
      ipam: kubernetes
      kube-proxy-replacement: 'false'
      enable-hubble: 'true'
      hubble-socket-path: /var/run/cilium/hubble.sock
      hubble-listen-address: :4244
      hubble-metrics-server: :9091
      hubble-metrics: dns drop tcp flow icmp http
      write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist
    ---
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      labels:
        app.kubernetes.io/name: cilium
        app.kubernetes.io/part-of: cilium
        k8s-app: cilium
      name: cilium
      namespace: kube-system
    spec:
      selector:
        matchLabels:
          k8s-app: cilium
      template:
        metadata:
          labels:
            app.kubernetes.io/name: cilium
            app.kubernetes.io/part-of: cilium
            k8s-app: cilium
        spec:
          automountServiceAccountToken: true
          containers:
          - args:
            - --config-dir=/tmp/cilium/config-map
            command:
            - cilium-agent
            env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: CILIUM_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: CILIUM_CLUSTERMESH_CONFIG
              value: /var/lib/cilium/clustermesh/
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  divisor: '1'
                  resource: limits.memory
            # TEMPLATED: External API endpoint from CAPI Cluster
            - name: KUBERNETES_SERVICE_HOST
              value: "{{ .Cluster.spec.controlPlaneEndpoint.host }}"
            - name: KUBERNETES_SERVICE_PORT
              value: "{{ .Cluster.spec.controlPlaneEndpoint.port }}"
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            livenessProbe:
              failureThreshold: 10
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9879
                scheme: HTTP
              periodSeconds: 30
              successThreshold: 1
              timeoutSeconds: 5
            name: cilium-agent
            readinessProbe:
              failureThreshold: 3
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9879
                scheme: HTTP
              initialDelaySeconds: 5
              periodSeconds: 30
              successThreshold: 1
              timeoutSeconds: 5
            resources:
              limits:
                memory: 1Gi
              requests:
                cpu: 100m
                memory: 512Mi
            securityContext:
              privileged: true
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /host/proc/sys/net
              name: host-proc-sys-net
            - mountPath: /host/proc/sys/kernel
              name: host-proc-sys-kernel
            - mountPath: /sys/fs/bpf
              mountPropagation: HostToContainer
              name: bpf-maps
            - mountPath: /var/run/cilium
              name: cilium-run
            - mountPath: /host/opt/cni/bin
              name: cni-path
            - mountPath: /host/etc/cni/net.d
              name: etc-cni-netd
            - mountPath: /tmp/cilium/config-map
              name: cilium-config-path
              readOnly: true
            - mountPath: /lib/modules
              name: lib-modules
              readOnly: true
            - mountPath: /run/xtables.lock
              name: xtables-lock
            - mountPath: /var/lib/cilium/tls/hubble
              name: hubble-tls
              readOnly: true
          hostNetwork: true
          initContainers:
          - command:
            - cilium-dbg
            - build-config
            env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: CILIUM_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            # TEMPLATED: External API endpoint from CAPI Cluster
            - name: KUBERNETES_SERVICE_HOST
              value: "{{ .Cluster.spec.controlPlaneEndpoint.host }}"
            - name: KUBERNETES_SERVICE_PORT
              value: "{{ .Cluster.spec.controlPlaneEndpoint.port }}"
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: config
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /tmp/cilium/config-map
              name: cilium-config-path
          - command:
            - sh
            - -ec
            - |
              cp /usr/bin/cilium-mount /hostbin/cilium-mount;
              nsenter --cgroup=/hostproc/1/ns/cgroup --mount=/hostproc/1/ns/mnt "${BIN_PATH}/cilium-mount" $CGROUP_ROOT;
              rm /hostbin/cilium-mount
            env:
            - name: CGROUP_ROOT
              value: /run/cilium/cgroupv2
            - name: BIN_PATH
              value: /opt/cni/bin
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: mount-cgroup
            securityContext:
              privileged: true
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /hostproc
              name: hostproc
            - mountPath: /hostbin
              name: cni-path
          - command:
            - sh
            - -ec
            - |
              cp /usr/bin/cilium-sysctlfix /hostbin/cilium-sysctlfix;
              nsenter --mount=/hostproc/1/ns/mnt "${BIN_PATH}/cilium-sysctlfix";
              rm /hostbin/cilium-sysctlfix
            env:
            - name: BIN_PATH
              value: /opt/cni/bin
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: apply-sysctl-overwrites
            securityContext:
              privileged: true
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /hostproc
              name: hostproc
            - mountPath: /hostbin
              name: cni-path
          - args:
            - mount | grep "/sys/fs/bpf type bpf" || mount -t bpf bpf /sys/fs/bpf
            command:
            - /bin/bash
            - -c
            - --
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: mount-bpf-fs
            securityContext:
              privileged: true
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /sys/fs/bpf
              mountPropagation: Bidirectional
              name: bpf-maps
          - command:
            - /init-container.sh
            env:
            - name: CILIUM_ALL_STATE
              valueFrom:
                configMapKeyRef:
                  key: clean-cilium-state
                  name: cilium-config
                  optional: true
            - name: CILIUM_BPF_STATE
              valueFrom:
                configMapKeyRef:
                  key: clean-cilium-bpf-state
                  name: cilium-config
                  optional: true
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: clean-cilium-state
            securityContext:
              capabilities:
                add:
                - NET_ADMIN
                - SYS_MODULE
                - SYS_ADMIN
                - SYS_RESOURCE
                drop:
                - ALL
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /sys/fs/bpf
              name: bpf-maps
            - mountPath: /run/cilium/cgroupv2
              mountPropagation: HostToContainer
              name: cilium-cgroup
            - mountPath: /var/run/cilium
              name: cilium-run
          - command:
            - /install-plugin.sh
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: install-cni-binaries
            resources:
              requests:
                cpu: 100m
                memory: 10Mi
            securityContext:
              capabilities:
                drop:
                - ALL
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /host/opt/cni/bin
              name: cni-path
          priorityClassName: system-node-critical
          restartPolicy: Always
          serviceAccount: cilium
          serviceAccountName: cilium
          terminationGracePeriodSeconds: 1
          tolerations:
          - operator: Exists
          volumes:
          - emptyDir: {}
            name: tmp
          - emptyDir: {}
            name: cilium-config-path
          - configMap:
              name: cilium-config
            name: cilium-config-source
          - hostPath:
              path: /var/run/cilium
              type: DirectoryOrCreate
            name: cilium-run
          - hostPath:
              path: /sys/fs/bpf
              type: DirectoryOrCreate
            name: bpf-maps
          - hostPath:
              path: /proc
              type: Directory
            name: hostproc
          - hostPath:
              path: /run/cilium/cgroupv2
              type: DirectoryOrCreate
            name: cilium-cgroup
          - hostPath:
              path: /opt/cni/bin
              type: DirectoryOrCreate
            name: cni-path
          - hostPath:
              path: /etc/cni/net.d
              type: DirectoryOrCreate
            name: etc-cni-netd
          - hostPath:
              path: /lib/modules
            name: lib-modules
          - hostPath:
              path: /run/xtables.lock
              type: FileOrCreate
            name: xtables-lock
          - hostPath:
              path: /proc/sys/net
              type: Directory
            name: host-proc-sys-net
          - hostPath:
              path: /proc/sys/kernel
              type: Directory
            name: host-proc-sys-kernel
          - name: hubble-tls
            projected:
              defaultMode: 256
              sources:
              - secret:
                  items:
                  - key: tls.crt
                    path: server.crt
                  - key: tls.key
                    path: server.key
                  - key: ca.crt
                    path: client-ca.crt
                  name: hubble-server-certs
                  optional: true
      updateStrategy:
        rollingUpdate:
          maxUnavailable: 2
        type: RollingUpdate
    ---
    # Cilium Operator with TEMPLATED external API endpoint
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app.kubernetes.io/name: cilium-operator
        app.kubernetes.io/part-of: cilium
        name: cilium-operator
      name: cilium-operator
      namespace: kube-system
    spec:
      replicas: 1
      selector:
        matchLabels:
          name: cilium-operator
      strategy:
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 1
        type: RollingUpdate
      template:
        metadata:
          labels:
            app.kubernetes.io/name: cilium-operator
            app.kubernetes.io/part-of: cilium
            name: cilium-operator
        spec:
          automountServiceAccountToken: true
          containers:
          - args:
            - --config-dir=/tmp/cilium/config-map
            - --debug=false
            command:
            - cilium-operator-generic
            env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: CILIUM_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: CILIUM_DEBUG
              valueFrom:
                configMapKeyRef:
                  key: debug
                  name: cilium-config
                  optional: true
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  divisor: '1'
                  resource: limits.memory
            # TEMPLATED: External API endpoint from CAPI Cluster
            - name: KUBERNETES_SERVICE_HOST
              value: "{{ .Cluster.spec.controlPlaneEndpoint.host }}"
            - name: KUBERNETES_SERVICE_PORT
              value: "{{ .Cluster.spec.controlPlaneEndpoint.port }}"
            image: quay.io/cilium/operator-generic:v1.16.5
            imagePullPolicy: IfNotPresent
            livenessProbe:
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9234
                scheme: HTTP
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 3
            name: cilium-operator
            readinessProbe:
              failureThreshold: 5
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9234
                scheme: HTTP
              initialDelaySeconds: 0
              periodSeconds: 5
              timeoutSeconds: 3
            resources:
              limits:
                memory: 1Gi
              requests:
                cpu: 100m
                memory: 128Mi
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /tmp/cilium/config-map
              name: cilium-config-path
              readOnly: true
          hostNetwork: true
          restartPolicy: Always
          serviceAccount: cilium-operator
          serviceAccountName: cilium-operator
          tolerations:
          - key: node.kubernetes.io/not-ready
            operator: Exists
          - key: node.kubernetes.io/unreachable
            operator: Exists
          - key: node.cloudprovider.kubernetes.io/uninitialized
            operator: Exists
          volumes:
          - configMap:
              name: cilium-config
            name: cilium-config-path
    ---
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        k8s-app: cilium
      name: hubble-peer
      namespace: kube-system
    spec:
      internalTrafficPolicy: Local
      ports:
      - name: peer-service
        port: 443
        protocol: TCP
        targetPort: 4244
      selector:
        k8s-app: cilium
