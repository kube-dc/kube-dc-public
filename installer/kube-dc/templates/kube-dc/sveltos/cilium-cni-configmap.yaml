apiVersion: v1
data:
  cilium.yaml: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: cilium
      namespace: kube-system
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: cilium-operator
      namespace: kube-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: cilium
    rules:
    - apiGroups:
      - networking.k8s.io
      resources:
      - networkpolicies
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - discovery.k8s.io
      resources:
      - endpointslices
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ''
      resources:
      - configmaps
      - namespaces
      - services
      - pods
      - pods/finalizers
      - endpoints
      - nodes
      - nodes/status
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ''
      resources:
      - pods
      - pods/status
      - pods/finalizers
      verbs:
      - update
      - patch
    - apiGroups:
      - ''
      resources:
      - nodes
      - nodes/status
      verbs:
      - patch
    - apiGroups:
      - apiextensions.k8s.io
      resources:
      - customresourcedefinitions
      verbs:
      - list
      - watch
      - get
    - apiGroups:
      - cilium.io
      resources:
      - '*'
      verbs:
      - '*'
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: cilium-operator
    rules:
    - apiGroups:
      - ''
      resources:
      - namespaces
      - pods
      verbs:
      - get
      - list
      - watch
      - delete
    - apiGroups:
      - ''
      resources:
      - nodes
      - services
      - endpoints
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - cilium.io
      resources:
      - '*'
      verbs:
      - '*'
    - apiGroups:
      - apiextensions.k8s.io
      resources:
      - customresourcedefinitions
      verbs:
      - create
      - get
      - list
      - watch
    - apiGroups:
      - coordination.k8s.io
      resources:
      - leases
      verbs:
      - create
      - get
      - update
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: cilium
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: cilium
    subjects:
    - kind: ServiceAccount
      name: cilium
      namespace: kube-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: cilium-operator
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: cilium-operator
    subjects:
    - kind: ServiceAccount
      name: cilium-operator
      namespace: kube-system
    ---
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: cilium-config
      namespace: kube-system
    data:
      debug: 'false'
      enable-policy: default
      enable-ipv4: 'true'
      enable-ipv6: 'false'
      custom-cni-conf: 'false'
      enable-bpf-clock-probe: 'true'
      monitor-aggregation: medium
      monitor-aggregation-interval: 5s
      monitor-aggregation-flags: all
      bpf-policy-map-max: '16384'
      bpf-map-dynamic-size-ratio: '0.0025'
      preallocate-bpf-maps: 'false'
      tunnel: vxlan
      cluster-name: default
      wait-bpf-mount: 'false'
      enable-endpoint-health-checking: 'true'
      enable-health-checking: 'true'
      enable-well-known-identities: 'false'
      enable-remote-node-identity: 'true'
      operator-api-serve-addr: 127.0.0.1:9234
      ipam: kubernetes
      kube-proxy-replacement: 'false'
      enable-hubble: 'true'
      hubble-socket-path: /var/run/cilium/hubble.sock
      hubble-listen-address: :4244
      hubble-metrics-server: :9091
      hubble-metrics: dns drop tcp flow icmp http
      write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist
    ---
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      labels:
        app.kubernetes.io/name: cilium
        app.kubernetes.io/part-of: cilium
        k8s-app: cilium
      name: cilium
      namespace: kube-system
    spec:
      selector:
        matchLabels:
          k8s-app: cilium
      template:
        metadata:
          labels:
            app.kubernetes.io/name: cilium
            app.kubernetes.io/part-of: cilium
            k8s-app: cilium
        spec:
          automountServiceAccountToken: true
          containers:
          - args:
            - --config-dir=/tmp/cilium/config-map
            command:
            - cilium-agent
            env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: CILIUM_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: CILIUM_CLUSTERMESH_CONFIG
              value: /var/lib/cilium/clustermesh/
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  divisor: '1'
                  resource: limits.memory
            # TEMPLATED: External API endpoint from CAPI Cluster
            - name: KUBERNETES_SERVICE_HOST
              value: "{{ .Cluster.spec.controlPlaneEndpoint.host }}"
            - name: KUBERNETES_SERVICE_PORT
              value: "{{ .Cluster.spec.controlPlaneEndpoint.port }}"
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            livenessProbe:
              failureThreshold: 10
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9879
                scheme: HTTP
              periodSeconds: 30
              successThreshold: 1
              timeoutSeconds: 5
            name: cilium-agent
            readinessProbe:
              failureThreshold: 3
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9879
                scheme: HTTP
              initialDelaySeconds: 5
              periodSeconds: 30
              successThreshold: 1
              timeoutSeconds: 5
            resources:
              limits:
                memory: 1Gi
              requests:
                cpu: 100m
                memory: 512Mi
            securityContext:
              privileged: true
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /host/proc/sys/net
              name: host-proc-sys-net
            - mountPath: /host/proc/sys/kernel
              name: host-proc-sys-kernel
            - mountPath: /sys/fs/bpf
              mountPropagation: HostToContainer
              name: bpf-maps
            - mountPath: /var/run/cilium
              name: cilium-run
            - mountPath: /host/opt/cni/bin
              name: cni-path
            - mountPath: /host/etc/cni/net.d
              name: etc-cni-netd
            - mountPath: /tmp/cilium/config-map
              name: cilium-config-path
              readOnly: true
            - mountPath: /lib/modules
              name: lib-modules
              readOnly: true
            - mountPath: /run/xtables.lock
              name: xtables-lock
            - mountPath: /var/lib/cilium/tls/hubble
              name: hubble-tls
              readOnly: true
          hostNetwork: true
          initContainers:
          - command:
            - cilium-dbg
            - build-config
            env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: CILIUM_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            # TEMPLATED: External API endpoint from CAPI Cluster
            - name: KUBERNETES_SERVICE_HOST
              value: "{{ .Cluster.spec.controlPlaneEndpoint.host }}"
            - name: KUBERNETES_SERVICE_PORT
              value: "{{ .Cluster.spec.controlPlaneEndpoint.port }}"
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: config
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /tmp/cilium/config-map
              name: cilium-config-path
          - command:
            - sh
            - -ec
            - |
              cp /usr/bin/cilium-mount /hostbin/cilium-mount;
              nsenter --cgroup=/hostproc/1/ns/cgroup --mount=/hostproc/1/ns/mnt "${BIN_PATH}/cilium-mount" $CGROUP_ROOT;
              rm /hostbin/cilium-mount
            env:
            - name: CGROUP_ROOT
              value: /run/cilium/cgroupv2
            - name: BIN_PATH
              value: /opt/cni/bin
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: mount-cgroup
            securityContext:
              privileged: true
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /hostproc
              name: hostproc
            - mountPath: /hostbin
              name: cni-path
          - command:
            - sh
            - -ec
            - |
              cp /usr/bin/cilium-sysctlfix /hostbin/cilium-sysctlfix;
              nsenter --mount=/hostproc/1/ns/mnt "${BIN_PATH}/cilium-sysctlfix";
              rm /hostbin/cilium-sysctlfix
            env:
            - name: BIN_PATH
              value: /opt/cni/bin
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: apply-sysctl-overwrites
            securityContext:
              privileged: true
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /hostproc
              name: hostproc
            - mountPath: /hostbin
              name: cni-path
          - args:
            - mount | grep "/sys/fs/bpf type bpf" || mount -t bpf bpf /sys/fs/bpf
            command:
            - /bin/bash
            - -c
            - --
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: mount-bpf-fs
            securityContext:
              privileged: true
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /sys/fs/bpf
              mountPropagation: Bidirectional
              name: bpf-maps
          - command:
            - /init-container.sh
            env:
            - name: CILIUM_ALL_STATE
              valueFrom:
                configMapKeyRef:
                  key: clean-cilium-state
                  name: cilium-config
                  optional: true
            - name: CILIUM_BPF_STATE
              valueFrom:
                configMapKeyRef:
                  key: clean-cilium-bpf-state
                  name: cilium-config
                  optional: true
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: clean-cilium-state
            securityContext:
              capabilities:
                add:
                - NET_ADMIN
                - SYS_MODULE
                - SYS_ADMIN
                - SYS_RESOURCE
                drop:
                - ALL
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /sys/fs/bpf
              name: bpf-maps
            - mountPath: /run/cilium/cgroupv2
              mountPropagation: HostToContainer
              name: cilium-cgroup
            - mountPath: /var/run/cilium
              name: cilium-run
          - command:
            - /install-plugin.sh
            image: quay.io/cilium/cilium:v1.16.5
            imagePullPolicy: IfNotPresent
            name: install-cni-binaries
            resources:
              requests:
                cpu: 100m
                memory: 10Mi
            securityContext:
              capabilities:
                drop:
                - ALL
              seLinuxOptions:
                level: s0
                type: spc_t
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /host/opt/cni/bin
              name: cni-path
          priorityClassName: system-node-critical
          restartPolicy: Always
          serviceAccount: cilium
          serviceAccountName: cilium
          terminationGracePeriodSeconds: 1
          tolerations:
          - operator: Exists
          volumes:
          - emptyDir: {}
            name: tmp
          - emptyDir: {}
            name: cilium-config-path
          - configMap:
              name: cilium-config
            name: cilium-config-source
          - hostPath:
              path: /var/run/cilium
              type: DirectoryOrCreate
            name: cilium-run
          - hostPath:
              path: /sys/fs/bpf
              type: DirectoryOrCreate
            name: bpf-maps
          - hostPath:
              path: /proc
              type: Directory
            name: hostproc
          - hostPath:
              path: /run/cilium/cgroupv2
              type: DirectoryOrCreate
            name: cilium-cgroup
          - hostPath:
              path: /opt/cni/bin
              type: DirectoryOrCreate
            name: cni-path
          - hostPath:
              path: /etc/cni/net.d
              type: DirectoryOrCreate
            name: etc-cni-netd
          - hostPath:
              path: /lib/modules
            name: lib-modules
          - hostPath:
              path: /run/xtables.lock
              type: FileOrCreate
            name: xtables-lock
          - hostPath:
              path: /proc/sys/net
              type: Directory
            name: host-proc-sys-net
          - hostPath:
              path: /proc/sys/kernel
              type: Directory
            name: host-proc-sys-kernel
          - name: hubble-tls
            projected:
              defaultMode: 256
              sources:
              - secret:
                  items:
                  - key: tls.crt
                    path: server.crt
                  - key: tls.key
                    path: server.key
                  - key: ca.crt
                    path: client-ca.crt
                  name: hubble-server-certs
                  optional: true
      updateStrategy:
        rollingUpdate:
          maxUnavailable: 2
        type: RollingUpdate
    ---
    # Cilium Operator with TEMPLATED external API endpoint
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app.kubernetes.io/name: cilium-operator
        app.kubernetes.io/part-of: cilium
        name: cilium-operator
      name: cilium-operator
      namespace: kube-system
    spec:
      replicas: 1
      selector:
        matchLabels:
          name: cilium-operator
      strategy:
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 1
        type: RollingUpdate
      template:
        metadata:
          labels:
            app.kubernetes.io/name: cilium-operator
            app.kubernetes.io/part-of: cilium
            name: cilium-operator
        spec:
          automountServiceAccountToken: true
          containers:
          - args:
            - --config-dir=/tmp/cilium/config-map
            - --debug=false
            command:
            - cilium-operator-generic
            env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: CILIUM_K8S_NAMESPACE
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
            - name: CILIUM_DEBUG
              valueFrom:
                configMapKeyRef:
                  key: debug
                  name: cilium-config
                  optional: true
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  divisor: '1'
                  resource: limits.memory
            # TEMPLATED: External API endpoint from CAPI Cluster
            - name: KUBERNETES_SERVICE_HOST
              value: "{{ .Cluster.spec.controlPlaneEndpoint.host }}"
            - name: KUBERNETES_SERVICE_PORT
              value: "{{ .Cluster.spec.controlPlaneEndpoint.port }}"
            image: quay.io/cilium/operator-generic:v1.16.5
            imagePullPolicy: IfNotPresent
            livenessProbe:
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9234
                scheme: HTTP
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 3
            name: cilium-operator
            readinessProbe:
              failureThreshold: 5
              httpGet:
                host: 127.0.0.1
                path: /healthz
                port: 9234
                scheme: HTTP
              initialDelaySeconds: 0
              periodSeconds: 5
              timeoutSeconds: 3
            resources:
              limits:
                memory: 1Gi
              requests:
                cpu: 100m
                memory: 128Mi
            terminationMessagePolicy: FallbackToLogsOnError
            volumeMounts:
            - mountPath: /tmp/cilium/config-map
              name: cilium-config-path
              readOnly: true
          hostNetwork: true
          restartPolicy: Always
          serviceAccount: cilium-operator
          serviceAccountName: cilium-operator
          tolerations:
          - key: node.kubernetes.io/not-ready
            operator: Exists
          - key: node.kubernetes.io/unreachable
            operator: Exists
          - key: node.cloudprovider.kubernetes.io/uninitialized
            operator: Exists
          volumes:
          - configMap:
              name: cilium-config
            name: cilium-config-path
    ---
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        k8s-app: cilium
      name: hubble-peer
      namespace: kube-system
    spec:
      internalTrafficPolicy: Local
      ports:
      - name: peer-service
        port: 443
        protocol: TCP
        targetPort: 4244
      selector:
        k8s-app: cilium
kind: ConfigMap
metadata:
  annotations:
      {"apiVersion":"v1","data":{"cilium.yaml":"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cilium\n  namespace: kube-system\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cilium-operator\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: cilium\nrules:\n- apiGroups:\n  - networking.k8s.io\n  resources:\n  - networkpolicies\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - discovery.k8s.io\n  resources:\n  - endpointslices\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - ''\n  resources:\n  - configmaps\n  - namespaces\n  - services\n  - pods\n  - pods/finalizers\n  - endpoints\n  - nodes\n  - nodes/status\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - ''\n  resources:\n  - pods\n  - pods/status\n  - pods/finalizers\n  verbs:\n  - update\n  - patch\n- apiGroups:\n  - ''\n  resources:\n  - nodes\n  - nodes/status\n  verbs:\n  - patch\n- apiGroups:\n  - apiextensions.k8s.io\n  resources:\n  - customresourcedefinitions\n  verbs:\n  - list\n  - watch\n  - get\n- apiGroups:\n  - cilium.io\n  resources:\n  - '*'\n  verbs:\n  - '*'\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: cilium-operator\nrules:\n- apiGroups:\n  - ''\n  resources:\n  - namespaces\n  - pods\n  verbs:\n  - get\n  - list\n  - watch\n  - delete\n- apiGroups:\n  - ''\n  resources:\n  - nodes\n  - services\n  - endpoints\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - cilium.io\n  resources:\n  - '*'\n  verbs:\n  - '*'\n- apiGroups:\n  - apiextensions.k8s.io\n  resources:\n  - customresourcedefinitions\n  verbs:\n  - create\n  - get\n  - list\n  - watch\n- apiGroups:\n  - coordination.k8s.io\n  resources:\n  - leases\n  verbs:\n  - create\n  - get\n  - update\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: cilium\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cilium\nsubjects:\n- kind: ServiceAccount\n  name: cilium\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: cilium-operator\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cilium-operator\nsubjects:\n- kind: ServiceAccount\n  name: cilium-operator\n  namespace: kube-system\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cilium-config\n  namespace: kube-system\ndata:\n  debug: 'false'\n  enable-policy: default\n  enable-ipv4: 'true'\n  enable-ipv6: 'false'\n  custom-cni-conf: 'false'\n  enable-bpf-clock-probe: 'true'\n  monitor-aggregation: medium\n  monitor-aggregation-interval: 5s\n  monitor-aggregation-flags: all\n  bpf-policy-map-max: '16384'\n  bpf-map-dynamic-size-ratio: '0.0025'\n  preallocate-bpf-maps: 'false'\n  tunnel: vxlan\n  cluster-name: default\n  wait-bpf-mount: 'false'\n  enable-endpoint-health-checking: 'true'\n  enable-health-checking: 'true'\n  enable-well-known-identities: 'false'\n  enable-remote-node-identity: 'true'\n  operator-api-serve-addr: 127.0.0.1:9234\n  ipam: kubernetes\n  kube-proxy-replacement: 'false'\n  enable-hubble: 'true'\n  hubble-socket-path: /var/run/cilium/hubble.sock\n  hubble-listen-address: :4244\n  hubble-metrics-server: :9091\n  hubble-metrics: dns drop tcp flow icmp http\n  write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: cilium\n    app.kubernetes.io/part-of: cilium\n    k8s-app: cilium\n  name: cilium\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      k8s-app: cilium\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: cilium\n        app.kubernetes.io/part-of: cilium\n        k8s-app: cilium\n    spec:\n      automountServiceAccountToken: true\n      containers:\n      - args:\n        - --config-dir=/tmp/cilium/config-map\n        command:\n        - cilium-agent\n        env:\n        - name: K8S_NODE_NAME\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: spec.nodeName\n        - name: CILIUM_K8S_NAMESPACE\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.namespace\n        - name: CILIUM_CLUSTERMESH_CONFIG\n          value: /var/lib/cilium/clustermesh/\n        - name: GOMEMLIMIT\n          valueFrom:\n            resourceFieldRef:\n              divisor: '1'\n              resource: limits.memory\n        # TEMPLATED: External API endpoint from CAPI Cluster\n        - name: KUBERNETES_SERVICE_HOST\n          value: \"{{ .Cluster.spec.controlPlaneEndpoint.host }}\"\n        - name: KUBERNETES_SERVICE_PORT\n          value: \"{{ .Cluster.spec.controlPlaneEndpoint.port }}\"\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          failureThreshold: 10\n          httpGet:\n            host: 127.0.0.1\n            path: /healthz\n            port: 9879\n            scheme: HTTP\n          periodSeconds: 30\n          successThreshold: 1\n          timeoutSeconds: 5\n        name: cilium-agent\n        readinessProbe:\n          failureThreshold: 3\n          httpGet:\n            host: 127.0.0.1\n            path: /healthz\n            port: 9879\n            scheme: HTTP\n          initialDelaySeconds: 5\n          periodSeconds: 30\n          successThreshold: 1\n          timeoutSeconds: 5\n        resources:\n          limits:\n            memory: 1Gi\n          requests:\n            cpu: 100m\n            memory: 512Mi\n        securityContext:\n          privileged: true\n          seLinuxOptions:\n            level: s0\n            type: spc_t\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /host/proc/sys/net\n          name: host-proc-sys-net\n        - mountPath: /host/proc/sys/kernel\n          name: host-proc-sys-kernel\n        - mountPath: /sys/fs/bpf\n          mountPropagation: HostToContainer\n          name: bpf-maps\n        - mountPath: /var/run/cilium\n          name: cilium-run\n        - mountPath: /host/opt/cni/bin\n          name: cni-path\n        - mountPath: /host/etc/cni/net.d\n          name: etc-cni-netd\n        - mountPath: /tmp/cilium/config-map\n          name: cilium-config-path\n          readOnly: true\n        - mountPath: /lib/modules\n          name: lib-modules\n          readOnly: true\n        - mountPath: /run/xtables.lock\n          name: xtables-lock\n        - mountPath: /var/lib/cilium/tls/hubble\n          name: hubble-tls\n          readOnly: true\n      hostNetwork: true\n      initContainers:\n      - command:\n        - cilium-dbg\n        - build-config\n        env:\n        - name: K8S_NODE_NAME\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: spec.nodeName\n        - name: CILIUM_K8S_NAMESPACE\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.namespace\n        # TEMPLATED: External API endpoint from CAPI Cluster\n        - name: KUBERNETES_SERVICE_HOST\n          value: \"{{ .Cluster.spec.controlPlaneEndpoint.host }}\"\n        - name: KUBERNETES_SERVICE_PORT\n          value: \"{{ .Cluster.spec.controlPlaneEndpoint.port }}\"\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        name: config\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /tmp/cilium/config-map\n          name: cilium-config-path\n      - command:\n        - sh\n        - -ec\n        - |\n          cp /usr/bin/cilium-mount /hostbin/cilium-mount;\n          nsenter --cgroup=/hostproc/1/ns/cgroup --mount=/hostproc/1/ns/mnt \"${BIN_PATH}/cilium-mount\" $CGROUP_ROOT;\n          rm /hostbin/cilium-mount\n        env:\n        - name: CGROUP_ROOT\n          value: /run/cilium/cgroupv2\n        - name: BIN_PATH\n          value: /opt/cni/bin\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        name: mount-cgroup\n        securityContext:\n          privileged: true\n          seLinuxOptions:\n            level: s0\n            type: spc_t\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /hostproc\n          name: hostproc\n        - mountPath: /hostbin\n          name: cni-path\n      - command:\n        - sh\n        - -ec\n        - |\n          cp /usr/bin/cilium-sysctlfix /hostbin/cilium-sysctlfix;\n          nsenter --mount=/hostproc/1/ns/mnt \"${BIN_PATH}/cilium-sysctlfix\";\n          rm /hostbin/cilium-sysctlfix\n        env:\n        - name: BIN_PATH\n          value: /opt/cni/bin\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        name: apply-sysctl-overwrites\n        securityContext:\n          privileged: true\n          seLinuxOptions:\n            level: s0\n            type: spc_t\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /hostproc\n          name: hostproc\n        - mountPath: /hostbin\n          name: cni-path\n      - args:\n        - mount | grep \"/sys/fs/bpf type bpf\" || mount -t bpf bpf /sys/fs/bpf\n        command:\n        - /bin/bash\n        - -c\n        - --\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        name: mount-bpf-fs\n        securityContext:\n          privileged: true\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /sys/fs/bpf\n          mountPropagation: Bidirectional\n          name: bpf-maps\n      - command:\n        - /init-container.sh\n        env:\n        - name: CILIUM_ALL_STATE\n          valueFrom:\n            configMapKeyRef:\n              key: clean-cilium-state\n              name: cilium-config\n              optional: true\n        - name: CILIUM_BPF_STATE\n          valueFrom:\n            configMapKeyRef:\n              key: clean-cilium-bpf-state\n              name: cilium-config\n              optional: true\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        name: clean-cilium-state\n        securityContext:\n          capabilities:\n            add:\n            - NET_ADMIN\n            - SYS_MODULE\n            - SYS_ADMIN\n            - SYS_RESOURCE\n            drop:\n            - ALL\n          seLinuxOptions:\n            level: s0\n            type: spc_t\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /sys/fs/bpf\n          name: bpf-maps\n        - mountPath: /run/cilium/cgroupv2\n          mountPropagation: HostToContainer\n          name: cilium-cgroup\n        - mountPath: /var/run/cilium\n          name: cilium-run\n      - command:\n        - /install-plugin.sh\n        image: quay.io/cilium/cilium:v1.16.5\n        imagePullPolicy: IfNotPresent\n        name: install-cni-binaries\n        resources:\n          requests:\n            cpu: 100m\n            memory: 10Mi\n        securityContext:\n          capabilities:\n            drop:\n            - ALL\n          seLinuxOptions:\n            level: s0\n            type: spc_t\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /host/opt/cni/bin\n          name: cni-path\n      priorityClassName: system-node-critical\n      restartPolicy: Always\n      serviceAccount: cilium\n      serviceAccountName: cilium\n      terminationGracePeriodSeconds: 1\n      tolerations:\n      - operator: Exists\n      volumes:\n      - emptyDir: {}\n        name: tmp\n      - emptyDir: {}\n        name: cilium-config-path\n      - configMap:\n          name: cilium-config\n        name: cilium-config-source\n      - hostPath:\n          path: /var/run/cilium\n          type: DirectoryOrCreate\n        name: cilium-run\n      - hostPath:\n          path: /sys/fs/bpf\n          type: DirectoryOrCreate\n        name: bpf-maps\n      - hostPath:\n          path: /proc\n          type: Directory\n        name: hostproc\n      - hostPath:\n          path: /run/cilium/cgroupv2\n          type: DirectoryOrCreate\n        name: cilium-cgroup\n      - hostPath:\n          path: /opt/cni/bin\n          type: DirectoryOrCreate\n        name: cni-path\n      - hostPath:\n          path: /etc/cni/net.d\n          type: DirectoryOrCreate\n        name: etc-cni-netd\n      - hostPath:\n          path: /lib/modules\n        name: lib-modules\n      - hostPath:\n          path: /run/xtables.lock\n          type: FileOrCreate\n        name: xtables-lock\n      - hostPath:\n          path: /proc/sys/net\n          type: Directory\n        name: host-proc-sys-net\n      - hostPath:\n          path: /proc/sys/kernel\n          type: Directory\n        name: host-proc-sys-kernel\n      - name: hubble-tls\n        projected:\n          defaultMode: 256\n          sources:\n          - secret:\n              items:\n              - key: tls.crt\n                path: server.crt\n              - key: tls.key\n                path: server.key\n              - key: ca.crt\n                path: client-ca.crt\n              name: hubble-server-certs\n              optional: true\n  updateStrategy:\n    rollingUpdate:\n      maxUnavailable: 2\n    type: RollingUpdate\n---\n# Cilium Operator with TEMPLATED external API endpoint\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app.kubernetes.io/name: cilium-operator\n    app.kubernetes.io/part-of: cilium\n    name: cilium-operator\n  name: cilium-operator\n  namespace: kube-system\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      name: cilium-operator\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: cilium-operator\n        app.kubernetes.io/part-of: cilium\n        name: cilium-operator\n    spec:\n      automountServiceAccountToken: true\n      containers:\n      - args:\n        - --config-dir=/tmp/cilium/config-map\n        - --debug=false\n        command:\n        - cilium-operator-generic\n        env:\n        - name: K8S_NODE_NAME\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: spec.nodeName\n        - name: CILIUM_K8S_NAMESPACE\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.namespace\n        - name: CILIUM_DEBUG\n          valueFrom:\n            configMapKeyRef:\n              key: debug\n              name: cilium-config\n              optional: true\n        - name: GOMEMLIMIT\n          valueFrom:\n            resourceFieldRef:\n              divisor: '1'\n              resource: limits.memory\n        # TEMPLATED: External API endpoint from CAPI Cluster\n        - name: KUBERNETES_SERVICE_HOST\n          value: \"{{ .Cluster.spec.controlPlaneEndpoint.host }}\"\n        - name: KUBERNETES_SERVICE_PORT\n          value: \"{{ .Cluster.spec.controlPlaneEndpoint.port }}\"\n        image: quay.io/cilium/operator-generic:v1.16.5\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          httpGet:\n            host: 127.0.0.1\n            path: /healthz\n            port: 9234\n            scheme: HTTP\n          initialDelaySeconds: 60\n          periodSeconds: 10\n          timeoutSeconds: 3\n        name: cilium-operator\n        readinessProbe:\n          failureThreshold: 5\n          httpGet:\n            host: 127.0.0.1\n            path: /healthz\n            port: 9234\n            scheme: HTTP\n          initialDelaySeconds: 0\n          periodSeconds: 5\n          timeoutSeconds: 3\n        resources:\n          limits:\n            memory: 1Gi\n          requests:\n            cpu: 100m\n            memory: 128Mi\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /tmp/cilium/config-map\n          name: cilium-config-path\n          readOnly: true\n      hostNetwork: true\n      restartPolicy: Always\n      serviceAccount: cilium-operator\n      serviceAccountName: cilium-operator\n      tolerations:\n      - key: node.kubernetes.io/not-ready\n        operator: Exists\n      - key: node.kubernetes.io/unreachable\n        operator: Exists\n      - key: node.cloudprovider.kubernetes.io/uninitialized\n        operator: Exists\n      volumes:\n      - configMap:\n          name: cilium-config\n        name: cilium-config-path\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    k8s-app: cilium\n  name: hubble-peer\n  namespace: kube-system\nspec:\n  internalTrafficPolicy: Local\n  ports:\n  - name: peer-service\n    port: 443\n    protocol: TCP\n    targetPort: 4244\n  selector:\n    k8s-app: cilium\n"},"kind":"ConfigMap","metadata":{"annotations":{"projectsveltos.io/template":"true"},"name":"cilium-cni-template","namespace":"projectsveltos"}}
    projectsveltos.io/template: "true"
  name: cilium-cni-template
  namespace: projectsveltos
