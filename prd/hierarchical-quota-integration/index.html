
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.kube-dc.com/prd/hierarchical-quota-integration/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>PRD: Hierarchical Resource Quota Integration for Kube-DC - Kube-DC</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prd-hierarchical-resource-quota-integration-for-kube-dc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Kube-DC" class="md-header__button md-logo" aria-label="Kube-DC" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kube-DC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PRD: Hierarchical Resource Quota Integration for Kube-DC
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/kube-dc/kube-dc-public" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    kube-dc/kube-dc-public
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../quickstart-overview/" class="md-tabs__link">
          
  
  
  Quick Start

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture-overview/" class="md-tabs__link">
          
  
  
  Architecture & Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorial-virtual-machines/" class="md-tabs__link">
          
  
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../project_resources/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../community-support/" class="md-tabs__link">
        
  
  
    
  
  Community & Support

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Kube-DC" class="md-nav__button md-logo" aria-label="Kube-DC" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Kube-DC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kube-dc/kube-dc-public" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    kube-dc/kube-dc-public
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Introduction
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What Is Kube-DC?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Features
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Quick Start
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart-hetzner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment on Hetzner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture & Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overall Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture-multi-tenancy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Tenancy & RBAC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture-virtualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtualization (KubeVirt)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture-networking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Networking (Kube-OVN, VLANs)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-virtual-machines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying VMs & Containers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-user-groups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User & Group Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-service-exposure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Service Exposure Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-networking-external/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Additional External Networks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-kubeconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuring Kubeconfig for Local Access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-windows-vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Windows VM Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial-sso-google-auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Google SSO Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../managing-os-images/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Managing OS Images
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project Resources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community-support/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Community & Support
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status-frozen" class="md-nav__link">
    <span class="md-ellipsis">
      
        Status: Frozen
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#branch-pricing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Branch: pricing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#priority-high" class="md-nav__link">
    <span class="md-ellipsis">
      
        Priority: High
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#last-updated-2026-02-07" class="md-nav__link">
    <span class="md-ellipsis">
      
        Last Updated: 2026-02-07
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Problem Statement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-goal" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Goal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-success-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Success Criteria
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-current-architecture-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Current Architecture Analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Current Architecture Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-namespace-hierarchy-already-exists" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Namespace Hierarchy (Already Exists)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-existing-billing-system" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Existing Billing System
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-existing-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 Existing Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-gap-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 Gap Analysis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-hnc-integration-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. HNC Integration Design
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. HNC Integration Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-hnc-component-pfnethierarchical-namespaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 HNC Component: pfnet/hierarchical-namespaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-namespace-hierarchy-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Namespace Hierarchy Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-hierarchicalresourcequota-hrq" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 HierarchicalResourceQuota (HRQ)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-limitrange-required-companion-to-hrq" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 LimitRange — Required Companion to HRQ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.4 LimitRange — Required Companion to HRQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#341-why-limitrange-is-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.1 Why LimitRange is Mandatory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#342-current-state-no-limitrange-exists" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.2 Current State — No LimitRange Exists
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#343-limitrange-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.3 LimitRange Design
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#344-hnc-propagation-of-limitrange" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.4 HNC Propagation of LimitRange
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#345-limitrange-as-standalone-kubernetes-object-hybrid-approach" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.5 LimitRange as Standalone Kubernetes Object (Hybrid Approach)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#346-limitrange-propagation-via-hnc" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4.6 LimitRange Propagation via HNC
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-per-project-sub-quotas-org-admin-managed" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 Per-Project Sub-Quotas (Org-Admin Managed)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.5 Per-Project Sub-Quotas (Org-Admin Managed)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#351-design-standard-kubernetes-resourcequota" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.1 Design: Standard Kubernetes ResourceQuota
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#352-rbac-org-admin-can-manage-resourcequota-in-project-namespaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.2 RBAC: Org-Admin Can Manage ResourceQuota in Project Namespaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#353-example-per-project-resourcequota" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.3 Example: Per-Project ResourceQuota
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#354-ui-integration-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.4 UI Integration (Optional)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#355-interaction-with-subscription-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5.5 Interaction with Subscription Lifecycle
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-plan-to-hrq-resource-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6 Plan-to-HRQ Resource Mapping
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Implementation Plan
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-hnc-installation-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: HNC Installation &amp; Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 1: HNC Installation &amp; Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#411-install-hnc-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1.1 Install HNC Controller
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#412-hnc-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1.2 HNC Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#413-rbac-for-hnc-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1.3 RBAC for HNC Resources
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-controller-changes-go" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Controller Changes (Go)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 2: Controller Changes (Go)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421-project-controller-set-namespace-parent" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2.1 Project Controller — Set Namespace Parent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#422-organization-controller-manage-hrq" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2.2 Organization Controller — Manage HRQ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#423-organization-controller-watch-annotation-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2.3 Organization Controller — Watch Annotation Changes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#424-organization-controller-manage-limitrange" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2.4 Organization Controller — Manage LimitRange
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-backend-changes-nodejs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: Backend Changes (Node.js)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 3: Backend Changes (Node.js)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-subscription-controller-createupdate-hrq-on-plan-change" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3.1 Subscription Controller — Create/Update HRQ on Plan Change
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-frontend-changes-reacttypescript" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 4: Frontend Changes (React/TypeScript)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 4: Frontend Changes (React/TypeScript)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441-billing-overview-show-real-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.1 Billing Overview — Show Real Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442-plan-selection-show-quota-impact" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.2 Plan Selection — Show Quota Impact
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-5-subscription-hrq-lifecycle-permission-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 5: Subscription → HRQ Lifecycle &amp; Permission Model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 5: Subscription → HRQ Lifecycle &amp; Permission Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#451-end-to-end-flow-who-changes-what" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.1 End-to-End Flow: Who Changes What
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#452-subscription-flows-in-detail" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.2 Subscription Flows in Detail
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#453-webhook-events-to-handle" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.3 Webhook Events to Handle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#454-add-on-flow-turbo-x1x2" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.4 Add-on Flow (Turbo x1/x2)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#455-permission-model-rbac" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.5 Permission Model (RBAC)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-migration-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Migration Strategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Migration Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-existing-organizations" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 Existing Organizations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-new-organizations" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 New Organizations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-resource-mapping-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Resource Mapping Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Resource Mapping Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-hrq-resource-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 HRQ Resource Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-object-storage-rook-ceph-s3-quotas" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Object Storage (Rook-Ceph S3 Quotas)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 Object Storage (Rook-Ceph S3 Quotas)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#621-how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.1 How It Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#622-integration-pattern-same-as-hrq" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.2 Integration Pattern (Same as HRQ)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#623-per-bucket-quotas-via-objectbucketclaim" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.3 Per-Bucket Quotas via ObjectBucketClaim
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#624-rbac-credential-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.4 RBAC &amp; Credential Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#625-subscription-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2.5 Subscription Lifecycle
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-kubevirt-vm-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 KubeVirt VM Resources
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-public-ipv4-eip-quota-enforcement" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 Public IPv4 (EIP) Quota Enforcement
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.4 Public IPv4 (EIP) Quota Enforcement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#641-why-hrq-cant-track-eips" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.1 Why HRQ Can’t Track EIPs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#642-design-eip-controller-quota-check" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.2 Design: EIP Controller Quota Check
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#643-plan-to-eip-quota-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.3 Plan-to-EIP Quota Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#644-what-counts-as-a-public-eip" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.4 What Counts as a Public EIP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#645-enforcement-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.5 Enforcement Points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#646-subscription-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.6 Subscription Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#647-usage-reporting" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4.7 Usage Reporting
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-kube-dc-system-resources" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 Kube-DC System Resources
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-edge-cases-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Edge Cases &amp; Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Edge Cases &amp; Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-quota-exceeded-on-plan-downgrade" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Quota Exceeded on Plan Downgrade
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-subscription-expiration-post-cancellation-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Subscription Expiration &amp; Post-Cancellation Lifecycle
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 Subscription Expiration &amp; Post-Cancellation Lifecycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-warning-before-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: Warning (before expiration)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-grace-period-7-days-after-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Grace Period (7 days after expiration)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-workload-suspension-after-grace-period-day-8" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: Workload Suspension (after grace period, day 8+)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-data-retention-day-30-configurable" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 4: Data Retention (day 30+, configurable)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-subscription-status-hrq-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary: Subscription Status → HRQ State
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stripe-annotation-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Stripe → Annotation State Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-hnc-controller-unavailability" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 HNC Controller Unavailability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74-race-conditions" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 Race Conditions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75-hnc-and-kube-ovn-interaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.5 HNC and Kube-OVN Interaction
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-api-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. API Changes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. API Changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-new-backend-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 New Backend Endpoints
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-organization-crd-changes-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 Organization CRD Changes (Optional)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-testing-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Testing Plan
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Testing Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 Unit Tests
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-e2e-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 E2E Tests
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-manual-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.3 Manual Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-deployment-sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Deployment Sequence
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Deployment Sequence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-phase-rollout" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 Phase Rollout
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-rollback-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Rollback Plan
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-files-to-createmodify" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Files to Create/Modify
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Files to Create/Modify">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-files" class="md-nav__link">
    <span class="md-ellipsis">
      
        New Files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modified-files" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modified Files
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go-dependencies-to-add" class="md-nav__link">
    <span class="md-ellipsis">
      
        Go Dependencies to Add
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-monitoring-observability" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Monitoring &amp; Observability
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Monitoring &amp; Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.1 Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-alerts" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.2 Alerts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.3 Logging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Security Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13. Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131-authentication-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        13.1 Authentication Layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132-rbac-separation" class="md-nav__link">
    <span class="md-ellipsis">
      
        13.2 RBAC Separation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133-stripe-webhook-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        13.3 Stripe Webhook Security
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#134-threat-mitigations" class="md-nav__link">
    <span class="md-ellipsis">
      
        13.4 Threat Mitigations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-open-questions" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. Open Questions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-references" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="prd-hierarchical-resource-quota-integration-for-kube-dc">PRD: Hierarchical Resource Quota Integration for Kube-DC<a class="headerlink" href="#prd-hierarchical-resource-quota-integration-for-kube-dc" title="Permanent link"> ¶</a></h1>
<h2 id="status-frozen">Status: Frozen<a class="headerlink" href="#status-frozen" title="Permanent link"> ¶</a></h2>
<h2 id="branch-pricing">Branch: <code>pricing</code><a class="headerlink" href="#branch-pricing" title="Permanent link"> ¶</a></h2>
<h2 id="priority-high">Priority: High<a class="headerlink" href="#priority-high" title="Permanent link"> ¶</a></h2>
<h2 id="last-updated-2026-02-07">Last Updated: 2026-02-07<a class="headerlink" href="#last-updated-2026-02-07" title="Permanent link"> ¶</a></h2>
<hr />
<h2 id="1-overview">1. Overview<a class="headerlink" href="#1-overview" title="Permanent link"> ¶</a></h2>
<h3 id="11-problem-statement">1.1 Problem Statement<a class="headerlink" href="#11-problem-statement" title="Permanent link"> ¶</a></h3>
<p>Kube-DC currently has a billing system with Stripe integration that defines subscription plans (Dev Pool, Pro Pool, Scale Pool) with resource limits (CPU, memory, storage, IPv4), but <strong>no actual Kubernetes-level enforcement</strong> of these limits. The <code>usage</code> field in the subscription data is hardcoded to <code>{ used: 0, limit: N }</code> (mock data). Organizations can exceed their plan limits without any restriction.</p>
<p>Additionally, the existing <code>OrganizationProjectsLimit</code> (default: 3) is a simple integer count — it limits the <em>number</em> of projects but not the <em>aggregate resource consumption</em> across projects.</p>
<h3 id="12-goal">1.2 Goal<a class="headerlink" href="#12-goal" title="Permanent link"> ¶</a></h3>
<p>Integrate <a href="https://github.com/pfnet/hierarchical-namespaces">Hierarchical Namespace Controller (HNC)</a> with <code>HierarchicalResourceQuota</code> (HRQ) to enforce organization-level resource quotas that aggregate across all project namespaces. When a user selects a billing plan, a corresponding HRQ is created/updated on the organization namespace, and Kubernetes natively enforces the limits across all child project namespaces.</p>
<h3 id="13-success-criteria">1.3 Success Criteria<a class="headerlink" href="#13-success-criteria" title="Permanent link"> ¶</a></h3>
<ul>
<li>Plan selection via UI creates a real <code>HierarchicalResourceQuota</code> on the organization namespace</li>
<li>Resource consumption across all projects in an organization is capped by the HRQ</li>
<li>Users see real-time quota usage in the Billing UI (not mock data)</li>
<li>Plan upgrades/downgrades dynamically update the HRQ</li>
<li>Turbo add-ons correctly increment HRQ limits</li>
<li>Existing organizations are migrated seamlessly</li>
</ul>
<hr />
<h2 id="2-current-architecture-analysis">2. Current Architecture Analysis<a class="headerlink" href="#2-current-architecture-analysis" title="Permanent link"> ¶</a></h2>
<h3 id="21-namespace-hierarchy-already-exists">2.1 Namespace Hierarchy (Already Exists)<a class="headerlink" href="#21-namespace-hierarchy-already-exists" title="Permanent link"> ¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Organization Namespace: shalb              ← Organization CR lives here
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  ├── Project Namespace: shalb-demo        ← Created by Project controller
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  ├── Project Namespace: shalb-dev         ← Created by Project controller
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  └── Project Namespace: shalb-envoy       ← Created by Project controller
</span></code></pre></div>
<p><strong>Key files:</strong>
- <code>api/kube-dc.com/v1/organization_types.go</code> — Organization CRD (namespace = org name)
- <code>api/kube-dc.com/v1/project_types.go</code> — Project CRD (namespace = org name, creates child ns <code>{org}-{project}</code>)
- <code>internal/project/helpers.go:94</code> — <code>ProjectNamespaceName()</code> returns <code>p.Namespace + "-" + p.Name</code>
- <code>internal/project/res_namespace.go</code> — Creates project namespace with annotation <code>kube-dc.com/project: {org}/{project}</code></p>
<h3 id="22-existing-billing-system">2.2 Existing Billing System<a class="headerlink" href="#22-existing-billing-system" title="Permanent link"> ¶</a></h3>
<p><strong>Backend (Node.js):</strong>
- <code>ui/backend/controllers/billing/subscriptionController.js</code> — Stripe integration, plan definitions, organization annotation management
- <code>ui/backend/controllers/billing/billingController.js</code> — Billing API proxy
- <code>ui/backend/routes/billing.js</code> — Route definitions</p>
<p><strong>Frontend (React/PatternFly):</strong>
- <code>ui/frontend/src/app/ManageOrganization/Billing/Billing.tsx</code> — Main billing UI (1133 lines)
- <code>ui/frontend/src/app/ManageOrganization/Billing/SubscribePlanModal.tsx</code> — Plan selection modal
- <code>ui/frontend/src/app/ManageOrganization/Billing/api.ts</code> — Billing API client
- <code>ui/frontend/src/app/ManageOrganization/Billing/types.ts</code> — TypeScript types and plan definitions</p>
<p><strong>Current Plans:</strong></p>
<table>
<thead>
<tr>
<th>Plan</th>
<th>CPU</th>
<th>Memory</th>
<th>Storage</th>
<th>Object Storage</th>
<th>IPv4</th>
<th>Price</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dev Pool</td>
<td>4 vCPU</td>
<td>8 GB</td>
<td>60 GB</td>
<td>20 GB</td>
<td>1</td>
<td>€19/mo</td>
</tr>
<tr>
<td>Pro Pool</td>
<td>8 vCPU</td>
<td>24 GB</td>
<td>160 GB</td>
<td>100 GB</td>
<td>1</td>
<td>€49/mo</td>
</tr>
<tr>
<td>Scale Pool</td>
<td>16 vCPU</td>
<td>56 GB</td>
<td>320 GB</td>
<td>500 GB</td>
<td>3</td>
<td>€99/mo</td>
</tr>
</tbody>
</table>
<p><strong>Turbo Add-ons:</strong></p>
<table>
<thead>
<tr>
<th>Add-on</th>
<th>CPU</th>
<th>Memory</th>
<th>Price</th>
</tr>
</thead>
<tbody>
<tr>
<td>Turbo x1</td>
<td>+2 vCPU</td>
<td>+4 GB</td>
<td>€9/mo</td>
</tr>
<tr>
<td>Turbo x2</td>
<td>+4 vCPU</td>
<td>+8 GB</td>
<td>€16/mo</td>
</tr>
</tbody>
</table>
<p><strong>Subscription data</strong> is stored as Organization annotations:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>billing.kube-dc.com/subscription: active
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>billing.kube-dc.com/plan-id: pro-pool
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>billing.kube-dc.com/plan-name: Pro Pool
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>billing.kube-dc.com/stripe-subscription-id: sub_xxx
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>billing.kube-dc.com/addons: [{&quot;addonId&quot;:&quot;turbo-x1&quot;,&quot;quantity&quot;:1}]
</span></code></pre></div></p>
<h3 id="23-existing-limits">2.3 Existing Limits<a class="headerlink" href="#23-existing-limits" title="Permanent link"> ¶</a></h3>
<ul>
<li><code>MasterConfigSpec.OrganizationProjectsLimit</code> (default: 3) — Checked in <code>CheckOrganizationLimits()</code> in <code>internal/controller/kube-dc.com/organization_controller.go:229</code></li>
<li>Project controller requeues with 30s delay when limit exceeded (<code>project_controller.go:148</code>)</li>
</ul>
<h3 id="24-gap-analysis">2.4 Gap Analysis<a class="headerlink" href="#24-gap-analysis" title="Permanent link"> ¶</a></h3>
<table>
<thead>
<tr>
<th>Capability</th>
<th>Current State</th>
<th>Target State</th>
</tr>
</thead>
<tbody>
<tr>
<td>Plan resource limits</td>
<td>Defined in code, not enforced</td>
<td>Enforced via HRQ</td>
</tr>
<tr>
<td>Usage tracking</td>
<td>Mock data (all zeros)</td>
<td>Real K8s ResourceQuota aggregation</td>
</tr>
<tr>
<td>Cross-project aggregation</td>
<td>None</td>
<td>HRQ aggregates across child namespaces</td>
</tr>
<tr>
<td>Enforcement</td>
<td>None (advisory only)</td>
<td>Hard limits at pod scheduling time</td>
</tr>
<tr>
<td>Plan change propagation</td>
<td>Annotations only</td>
<td>HRQ spec update</td>
</tr>
<tr>
<td>Add-on resource addition</td>
<td>Annotations only</td>
<td>HRQ spec update</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-hnc-integration-design">3. HNC Integration Design<a class="headerlink" href="#3-hnc-integration-design" title="Permanent link"> ¶</a></h2>
<h3 id="31-hnc-component-pfnethierarchical-namespaces">3.1 HNC Component: pfnet/hierarchical-namespaces<a class="headerlink" href="#31-hnc-component-pfnethierarchical-namespaces" title="Permanent link"> ¶</a></h3>
<p><strong>Repository:</strong> https://github.com/pfnet/hierarchical-namespaces<br />
<strong>Latest Release:</strong> <code>v1.1.0-pfnet.10</code><br />
<strong>Image:</strong> <code>ghcr.io/pfnet/hierarchical-namespaces/controller:v1.1.0-pfnet.10</code><br />
<strong>HRQ CRD API:</strong> <code>hnc.x-k8s.io/v1alpha2</code></p>
<p>HNC provides:
1. <strong>Namespace hierarchy</strong> — Parent-child relationships between namespaces
2. <strong>Policy propagation</strong> — RBAC, NetworkPolicies, Secrets propagated to children
3. <strong>HierarchicalResourceQuota (HRQ)</strong> — Aggregate quota across a namespace subtree</p>
<h3 id="32-namespace-hierarchy-mapping">3.2 Namespace Hierarchy Mapping<a class="headerlink" href="#32-namespace-hierarchy-mapping" title="Permanent link"> ¶</a></h3>
<p>HNC requires setting parent-child relationships on namespaces. The Kube-DC hierarchy maps naturally:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>shalb (Organization namespace)          ← HRQ &quot;plan-quota&quot; applied here
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>├── shalb-demo (Project namespace)      ← child of shalb
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>├── shalb-dev (Project namespace)       ← child of shalb
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>└── shalb-envoy (Project namespace)     ← child of shalb
</span></code></pre></div>
<p><strong>HNC hierarchy is set via annotations/labels on namespaces:</strong>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shalb-demo</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nt">shalb.tree.hnc.x-k8s.io/depth</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w">    </span><span class="c1"># Set by HNC controller</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nt">hnc.x-k8s.io/subnamespace-of</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shalb</span><span class="w">    </span><span class="c1"># OR use HierarchyConfiguration</span>
</span></code></pre></div></p>
<p><strong>OR via HierarchyConfiguration:</strong>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hnc.x-k8s.io/v1alpha2</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HierarchyConfiguration</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hierarchy</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shalb-demo</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="nt">parent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shalb</span>
</span></code></pre></div></p>
<h3 id="33-hierarchicalresourcequota-hrq">3.3 HierarchicalResourceQuota (HRQ)<a class="headerlink" href="#33-hierarchicalresourcequota-hrq" title="Permanent link"> ¶</a></h3>
<p>Applied on the organization namespace, limits are enforced across ALL child project namespaces:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hnc.x-k8s.io/v1alpha2</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HierarchicalResourceQuota</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plan-quota</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shalb</span><span class="w">                    </span><span class="c1"># Organization namespace</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="nt">billing.kube-dc.com/auto-managed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="nt">billing.kube-dc.com/plan-id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pro-pool&quot;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">  </span><span class="nt">hard</span><span class="p">:</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="nt">requests.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span><span class="w">                 </span><span class="c1"># From plan: 8 vCPU</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24Gi&quot;</span><span class="w">           </span><span class="c1"># From plan: 24 GB</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="nt">limits.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16&quot;</span><span class="w">                  </span><span class="c1"># 2x burst for pro-pool (see §3.6)</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="nt">limits.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;48Gi&quot;</span><span class="w">             </span><span class="c1"># 2x burst for pro-pool</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="nt">requests.storage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;160Gi&quot;</span><span class="w">         </span><span class="c1"># From plan: 160 GB storage</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;200&quot;</span><span class="w">                       </span><span class="c1"># Per-plan: 100/200/500</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="nt">services.loadbalancers</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span><span class="w">       </span><span class="c1"># Per-plan: 3/5/10</span>
</span></code></pre></div>
<p><strong>HRQ Status (populated by HNC controller):</strong>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">status</span><span class="p">:</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="nt">hard</span><span class="p">:</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="nt">requests.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24Gi&quot;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="nt">used</span><span class="p">:</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="nt">requests.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2500m&quot;</span><span class="w">             </span><span class="c1"># Aggregated across all child namespaces</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6Gi&quot;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span></code></pre></div></p>
<h3 id="34-limitrange-required-companion-to-hrq">3.4 LimitRange — Required Companion to HRQ<a class="headerlink" href="#34-limitrange-required-companion-to-hrq" title="Permanent link"> ¶</a></h3>
<h4 id="341-why-limitrange-is-mandatory">3.4.1 Why LimitRange is Mandatory<a class="headerlink" href="#341-why-limitrange-is-mandatory" title="Permanent link"> ¶</a></h4>
<p><strong>Critical Kubernetes behavior:</strong> When a <code>ResourceQuota</code> (or HRQ, which creates internal <code>ResourceQuota</code> objects named <code>hrq.hnc.x-k8s.io</code> in each child namespace) constrains <code>cpu</code> or <code>memory</code>, Kubernetes <strong>rejects</strong> any pod that does not explicitly set <code>requests</code> or <code>limits</code> for those resources:</p>
<blockquote>
<p><em>For <code>cpu</code> and <code>memory</code> resources, ResourceQuotas enforce that </em><em>every</em><em> (new) pod in that namespace sets a limit for that resource. If you don't, the control plane may reject admission for that Pod.</em>
— <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">Kubernetes Documentation</a></p>
</blockquote>
<p>This means:
- Once HRQ is applied to an organization namespace, <strong>all project namespaces get internal ResourceQuotas</strong>
- Any pod (container, KubeVirt VM, cloud-shell job, VPC DNS pod) created <strong>without</strong> explicit <code>resources.requests.cpu</code> / <code>resources.requests.memory</code> will be <strong>rejected</strong> by the API server
- <strong>LimitRange solves this</strong> by providing default <code>requests</code> and <code>limits</code> for containers that don't specify them</p>
<h4 id="342-current-state-no-limitrange-exists">3.4.2 Current State — No LimitRange Exists<a class="headerlink" href="#342-current-state-no-limitrange-exists" title="Permanent link"> ¶</a></h4>
<p>The kube-dc codebase has <strong>zero</strong> LimitRange resources. Key workloads that currently omit explicit resource requests:</p>
<table>
<thead>
<tr>
<th>Workload</th>
<th>File</th>
<th>Sets requests/limits?</th>
</tr>
</thead>
<tbody>
<tr>
<td>KubeVirt VMs</td>
<td><code>AddNewVMModal.tsx:377-380</code></td>
<td>Sets <code>domain.cpu.cores</code> and <code>domain.memory.guest</code> but <strong>NOT</strong> pod-level <code>resources.requests</code> (KubeVirt auto-generates these from domain spec)</td>
</tr>
<tr>
<td>Cloud-shell SSH jobs</td>
<td><code>cloudshell-job.tmpl.yaml</code></td>
<td>Likely no resource requests</td>
</tr>
<tr>
<td>VPC DNS pods</td>
<td><code>res_vpc_dns.go</code></td>
<td>Created by Kube-OVN, may lack requests</td>
</tr>
<tr>
<td>User-deployed pods</td>
<td>User YAML</td>
<td>No guarantee of resource requests</td>
</tr>
</tbody>
</table>
<p><strong>KubeVirt note:</strong> KubeVirt's <code>virt-controller</code> translates <code>domain.cpu.cores</code> and <code>domain.memory.guest</code> into pod-level <code>resources.requests</code> and <code>resources.limits</code> automatically. So KubeVirt VMs <strong>should</strong> work with ResourceQuota, but this must be verified.</p>
<h4 id="343-limitrange-design">3.4.3 LimitRange Design<a class="headerlink" href="#343-limitrange-design" title="Permanent link"> ¶</a></h4>
<p>Create a <code>LimitRange</code> in the <strong>organization namespace</strong> and use <strong>HNC propagation</strong> to automatically copy it to all project namespaces.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LimitRange</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-resource-limits</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shalb</span><span class="w">                    </span><span class="c1"># Organization namespace</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="nt">billing.kube-dc.com/auto-managed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">  </span><span class="nt">limits</span><span class="p">:</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="c1"># Default requests/limits for Containers</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Container</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">      </span><span class="nt">default</span><span class="p">:</span><span class="w">                        </span><span class="c1"># Default limits (if not specified)</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500m</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512Mi</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">      </span><span class="nt">defaultRequest</span><span class="p">:</span><span class="w">                 </span><span class="c1"># Default requests (if not specified)</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128Mi</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">      </span><span class="nt">max</span><span class="p">:</span><span class="w">                            </span><span class="c1"># Max per container (prevents single container from consuming entire quota)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32Gi</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">      </span><span class="nt">min</span><span class="p">:</span><span class="w">                            </span><span class="c1"># Minimum per container</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16Mi</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="c1"># Default requests/limits for Pods</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">      </span><span class="nt">max</span><span class="p">:</span><span class="w">                            </span><span class="c1"># Max per pod (all containers combined)</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16&quot;</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64Gi</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="c1"># PVC size limits</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">      </span><span class="nt">max</span><span class="p">:</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">        </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500Gi</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">      </span><span class="nt">min</span><span class="p">:</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">        </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span></code></pre></div>
<p><strong>How this works with HRQ:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>1. User creates pod WITHOUT resources.requests/limits
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>2. LimitRange admission controller applies defaults (cpu: 100m, memory: 128Mi)
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>3. HRQ admission controller checks aggregated usage against quota
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>4. Pod is admitted if within quota, rejected if over quota
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>Order of admission controllers: LimitRange → ResourceQuota/HRQ
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>(LimitRange runs BEFORE ResourceQuota, so defaults are applied first)
</span></code></pre></div>
<h4 id="344-hnc-propagation-of-limitrange">3.4.4 HNC Propagation of LimitRange<a class="headerlink" href="#344-hnc-propagation-of-limitrange" title="Permanent link"> ¶</a></h4>
<p>HNC can propagate LimitRange objects from parent namespace to all child namespaces. This is the <strong>recommended approach</strong> because:</p>
<ol>
<li><strong>Single source of truth</strong> — Define once in org namespace, propagated to all projects</li>
<li><strong>Automatic updates</strong> — Change the LimitRange in org namespace → HNC updates all children</li>
<li><strong>No controller code needed</strong> — HNC handles propagation natively</li>
<li><strong>Immutable in children</strong> — HNC admission webhook prevents modification of propagated copies</li>
</ol>
<p>Configure HNC to propagate LimitRange:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hnc.x-k8s.io/v1alpha2</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HNCConfiguration</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">limitranges</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Propagate</span><span class="w">              </span><span class="c1"># Propagate from org → project namespaces</span>
</span></code></pre></div>
<p>After this, a LimitRange created in <code>shalb</code> (org namespace) will be automatically copied to <code>shalb-demo</code>, <code>shalb-dev</code>, <code>shalb-envoy</code> (all project namespaces).</p>
<h4 id="345-limitrange-as-standalone-kubernetes-object-hybrid-approach">3.4.5 LimitRange as Standalone Kubernetes Object (Hybrid Approach)<a class="headerlink" href="#345-limitrange-as-standalone-kubernetes-object-hybrid-approach" title="Permanent link"> ¶</a></h4>
<p>LimitRange is a <strong>standard Kubernetes object</strong> — no need to embed it into the Organization CRD. Instead, the controller auto-creates a LimitRange with plan-based defaults, and the org admin can override it by creating their own.</p>
<p><strong>Design: controller auto-creation + user override</strong></p>
<ol>
<li>When a billing plan is activated, the Organization controller checks if a LimitRange named <code>default-resource-limits</code> exists in the org namespace</li>
<li>If <strong>no LimitRange exists</strong> → controller creates one with plan-based defaults and labels it <code>billing.kube-dc.com/auto-managed: "true"</code></li>
<li>If a <strong>user-created LimitRange exists</strong> (without the <code>auto-managed</code> label) → controller does NOT overwrite it, user owns the resource policy</li>
<li>If the <strong>auto-managed LimitRange exists</strong> and the plan changes → controller updates it with new plan defaults</li>
<li>HNC propagates the LimitRange (regardless of who created it) to all project namespaces</li>
</ol>
<p><strong>Ownership detection via labels:</strong></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Controller-managed (auto-created, will be updated on plan change)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="nt">billing.kube-dc.com/auto-managed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span><span class="nt">billing.kube-dc.com/plan-id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pro-pool&quot;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c1"># User-managed (controller will NOT touch this)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="c1"># No billing.kube-dc.com/auto-managed label</span>
</span></code></pre></div>
<p><strong>Benefits of this approach:</strong>
- <strong>No CRD changes</strong> — Organization spec stays clean, no API bloat
- <strong>Standard Kubernetes</strong> — org admins who know K8s can use native LimitRange directly
- <strong>Auto-defaults for everyone</strong> — users who don't know/care get sensible defaults from their plan
- <strong>User can customize</strong> — just create/edit a LimitRange in the org namespace, controller backs off
- <strong>Future-proof</strong> — any new LimitRange features work immediately without CRD updates
- <strong>Separation of concerns</strong> — billing/identity (Organization CRD) separate from resource policy (LimitRange)</p>
<p><strong>Edge cases:</strong></p>
<ul>
<li><strong>User edits auto-managed LimitRange:</strong> Controller will overwrite it back to plan defaults on the next reconciliation (the <code>auto-managed</code> label is still present). This is enforced behavior. The controller <strong>should emit a Kubernetes Event</strong> (via <code>EventRecorder</code>) when it detects and overwrites user changes to an auto-managed resource, so the action is auditable and visible in <code>kubectl describe limitrange</code>.</li>
<li><strong>User removes the <code>auto-managed</code> label:</strong> Controller treats it as user-managed and stops updating it. This is acceptable — the HRQ still enforces aggregate quota. The user effectively "detached" the LimitRange from plan auto-updates. This is a valid power-user action, not a bug.</li>
</ul>
<p><strong>Plan-based auto-defaults</strong> (used when controller creates the LimitRange):</p>
<table>
<thead>
<tr>
<th>Plan</th>
<th>Default Request CPU</th>
<th>Default Request Memory</th>
<th>Default Limit CPU</th>
<th>Default Limit Memory</th>
<th>Max CPU</th>
<th>Max Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dev Pool (4 CPU)</td>
<td>100m</td>
<td>128Mi</td>
<td>500m</td>
<td>512Mi</td>
<td>2</td>
<td>4Gi</td>
</tr>
<tr>
<td>Pro Pool (8 CPU)</td>
<td>250m</td>
<td>256Mi</td>
<td>500m</td>
<td>512Mi</td>
<td>4</td>
<td>12Gi</td>
</tr>
<tr>
<td>Scale Pool (16 CPU)</td>
<td>500m</td>
<td>512Mi</td>
<td>1</td>
<td>1Gi</td>
<td>8</td>
<td>32Gi</td>
</tr>
</tbody>
</table>
<p><strong>Rationale:</strong> Smaller plans need lower <code>max</code> to prevent a single container from consuming the entire quota. Container defaults should be reasonable for typical workloads — not too low (causes constant OOMKill) or too high (wastes quota).</p>
<p><strong>Intentional: LimitRange max &lt; HRQ burst limits.</strong> For Dev Pool, HRQ allows 12 CPU burst (3x), but LimitRange caps a single container at 2 CPU and a single pod at 4 CPU. This means a user needs at least 3 pods (4+4+4) to utilize the full burst capacity. This is <strong>by design</strong> — it prevents a single runaway pod from starving all other workloads in the organization. Users with "single heavy task" workloads (e.g., a large build job) are limited to the per-pod max, even if the HRQ has headroom. If this is too restrictive for a specific org, the org-admin can override the LimitRange (see edge cases above).</p>
<h4 id="346-limitrange-propagation-via-hnc">3.4.6 LimitRange Propagation via HNC<a class="headerlink" href="#346-limitrange-propagation-via-hnc" title="Permanent link"> ¶</a></h4>
<p>HNC propagation is the recommended approach:</p>
<ol>
<li><strong>Create LimitRange in org namespace</strong> → HNC auto-copies to all project namespaces</li>
<li><strong>Single source of truth</strong> — change once, propagated everywhere</li>
<li><strong>Immutable in children</strong> — HNC admission webhook prevents users from modifying propagated copies</li>
<li><strong>Automatic cleanup</strong> — delete from org namespace, HNC removes all copies</li>
<li><strong>Works regardless of who created it</strong> — both controller-managed and user-managed LimitRanges are propagated</li>
</ol>
<p><strong>Alternative (not recommended):</strong> Create LimitRange directly in each project namespace via Project controller. This requires:
- Extra controller code per project
- Synchronization when org defaults change (must update all projects)
- More RBAC surface area</p>
<p><strong>Recommendation:</strong> Use HNC propagation. Fall back to direct creation only if HNC propagation proves problematic.</p>
<h3 id="35-per-project-sub-quotas-org-admin-managed">3.5 Per-Project Sub-Quotas (Org-Admin Managed)<a class="headerlink" href="#35-per-project-sub-quotas-org-admin-managed" title="Permanent link"> ¶</a></h3>
<p>HRQ enforces the <strong>aggregate</strong> limit across all projects. But org-admins also need to limit individual projects — e.g., "dev project gets max 2 CPU, production project gets 6 CPU" within an 8 CPU org total.</p>
<h4 id="351-design-standard-kubernetes-resourcequota">3.5.1 Design: Standard Kubernetes ResourceQuota<a class="headerlink" href="#351-design-standard-kubernetes-resourcequota" title="Permanent link"> ¶</a></h4>
<p>Per-project quotas use <strong>standard Kubernetes <code>ResourceQuota</code></strong> — no custom CRDs. This works because:</p>
<ol>
<li>HRQ creates internal ResourceQuota objects in child namespaces (managed by HNC, names prefixed <code>hrq-*</code>)</li>
<li>Org-admin creates <strong>additional</strong> ResourceQuota in the project namespace</li>
<li>Kubernetes applies <strong>all</strong> ResourceQuotas in a namespace — the most restrictive limit wins per resource</li>
<li>HRQ still enforces the org-level cap (sum of all projects can't exceed org total)</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>Organization: acme-corp (HRQ: 8 CPU total)
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>  ├── acme-corp-dev        ResourceQuota: 2 CPU    ← org-admin sets this
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>  ├── acme-corp-staging    ResourceQuota: 2 CPU    ← org-admin sets this
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>  └── acme-corp-prod       (no ResourceQuota)      ← gets remainder up to HRQ limit
</span></code></pre></div>
<p>In this example:
- <code>acme-corp-dev</code> can use <strong>at most</strong> 2 CPU (ResourceQuota caps it)
- <code>acme-corp-prod</code> can use up to 8 CPU minus whatever dev+staging consume (HRQ caps it)
- Total across all projects can never exceed 8 CPU (HRQ enforces)</p>
<h4 id="352-rbac-org-admin-can-manage-resourcequota-in-project-namespaces">3.5.2 RBAC: Org-Admin Can Manage ResourceQuota in Project Namespaces<a class="headerlink" href="#352-rbac-org-admin-can-manage-resourcequota-in-project-namespaces" title="Permanent link"> ¶</a></h4>
<p>Org-admin needs write access to <code>resourcequotas</code> in project namespaces. This is added to the existing org-admin Role:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Added to the org-admin Role in each project namespace</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;resourcequotas&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<p><strong>Constraints:</strong>
- Org-admin <strong>can</strong> set per-project ResourceQuota (limits individual projects)
- Org-admin <strong>cannot</strong> modify HRQ-managed internal ResourceQuota (names prefixed <code>hrq-*</code>, managed by HNC)
- Org-admin <strong>cannot</strong> set per-project limits higher than the org HRQ (Kubernetes enforces: the most restrictive wins)
- HNC admission webhook blocks modification of HRQ-internal ResourceQuota objects</p>
<h4 id="353-example-per-project-resourcequota">3.5.3 Example: Per-Project ResourceQuota<a class="headerlink" href="#353-example-per-project-resourcequota" title="Permanent link"> ¶</a></h4>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Created by org-admin in the project namespace</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ResourceQuota</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">project-quota</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-corp-dev</span><span class="w">           </span><span class="c1"># project namespace</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span><span class="nt">hard</span><span class="p">:</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="nt">requests.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4Gi&quot;</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="nt">limits.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="nt">limits.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8Gi&quot;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="nt">requests.storage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20Gi&quot;</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50&quot;</span>
</span></code></pre></div>
<p>This coexists with the HRQ-managed internal ResourceQuota. The effective limit per resource is <code>min(project-quota, hrq-internal-quota)</code>.</p>
<h4 id="354-ui-integration-optional">3.5.4 UI Integration (Optional)<a class="headerlink" href="#354-ui-integration-optional" title="Permanent link"> ¶</a></h4>
<p>The console can expose per-project quota management under <strong>Project Settings → Resource Limits</strong>:</p>
<ul>
<li>Show current project usage vs project quota vs org HRQ remaining</li>
<li>Form to set per-project limits (creates/updates ResourceQuota via backend API)</li>
<li>Validation: warn if sum of all project quotas exceeds org HRQ total</li>
<li>Backend endpoint: <code>PUT /api/projects/:namespace/quota</code> — creates ResourceQuota using SA token</li>
</ul>
<blockquote>
<p><strong>Note:</strong> UI for per-project quota management is <strong>needed but late-stage</strong> (post-MVP). For MVP, org-admins use <code>kubectl</code> directly since this is standard Kubernetes. The UI page should be implemented after the core HRQ + LimitRange + subscription lifecycle is stable.</p>
</blockquote>
<h4 id="355-interaction-with-subscription-lifecycle">3.5.5 Interaction with Subscription Lifecycle<a class="headerlink" href="#355-interaction-with-subscription-lifecycle" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th>Subscription Status</th>
<th>Org HRQ</th>
<th>Per-Project ResourceQuota</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>active</code></td>
<td>Full plan limits</td>
<td>Org-admin managed, respected</td>
</tr>
<tr>
<td><code>suspended</code></td>
<td>Minimal (0.5 CPU)</td>
<td>Still exists but effectively capped by HRQ</td>
</tr>
<tr>
<td><code>canceled</code></td>
<td>Minimal (0.5 CPU)</td>
<td>Still exists, workloads scaled to 0 anyway</td>
</tr>
<tr>
<td>Re-subscribe</td>
<td>Full plan limits restored</td>
<td>Per-project quotas still in place, unmodified</td>
</tr>
</tbody>
</table>
<p>Per-project ResourceQuotas are <strong>not touched</strong> by the subscription lifecycle — they are org-admin's responsibility. Only the org-level HRQ changes with subscription status.</p>
<h3 id="36-plan-to-hrq-resource-mapping">3.6 Plan-to-HRQ Resource Mapping<a class="headerlink" href="#36-plan-to-hrq-resource-mapping" title="Permanent link"> ¶</a></h3>
<p><strong>Burst ratios vary by plan tier</strong> — dev workloads are bursty and low-risk, production workloads need predictability:</p>
<table>
<thead>
<tr>
<th>Plan</th>
<th>Burst Ratio (limits/requests)</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dev Pool</td>
<td>3x</td>
<td>Dev/sandbox workloads are bursty, low overcommit risk</td>
</tr>
<tr>
<td>Pro Pool</td>
<td>2x</td>
<td>Balanced burst for general workloads</td>
</tr>
<tr>
<td>Scale Pool</td>
<td>1.5x</td>
<td>Production workloads need predictability, less overcommit</td>
</tr>
</tbody>
</table>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">// Burst ratio per plan tier</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">BURST_RATIOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="s1">&#39;dev-pool&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="s1">&#39;pro-pool&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="s1">&#39;scale-pool&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="p">};</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="c1">// Mapping function: Plan resources → HRQ spec.hard</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="kd">function</span><span class="w"> </span><span class="nx">planToHRQ</span><span class="p">(</span><span class="nx">plan</span><span class="p">,</span><span class="w"> </span><span class="nx">addons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalCpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">cpu</span><span class="p">;</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">totalMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">memory</span><span class="p">;</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">addon</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">addons</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">addonDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TURBO_ADDONS</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">addon</span><span class="p">.</span><span class="nx">addonId</span><span class="p">);</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">addonDef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">            </span><span class="nx">totalCpu</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">addonDef</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">cpu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">addon</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">            </span><span class="nx">totalMemory</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">addonDef</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">memory</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">addon</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">BURST_RATIOS</span><span class="p">[</span><span class="nx">plan</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">        </span><span class="s1">&#39;requests.cpu&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">totalCpu</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">        </span><span class="s1">&#39;requests.memory&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">totalMemory</span><span class="si">}</span><span class="sb">Gi`</span><span class="p">,</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">        </span><span class="s1">&#39;limits.cpu&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">totalCpu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">burst</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w">             </span><span class="c1">// per-plan burst</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">        </span><span class="s1">&#39;limits.memory&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">totalMemory</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">burst</span><span class="si">}</span><span class="sb">Gi`</span><span class="p">,</span><span class="w">     </span><span class="c1">// per-plan burst</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">        </span><span class="s1">&#39;requests.storage&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">plan</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">storage</span><span class="si">}</span><span class="sb">Gi`</span><span class="p">,</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">        </span><span class="s1">&#39;pods&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;dev-pool&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;100&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;pro-pool&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;200&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;500&#39;</span><span class="p">,</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="w">        </span><span class="s1">&#39;services.loadbalancers&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;dev-pool&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;pro-pool&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10&#39;</span><span class="p">,</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Resulting HRQ values per plan:</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>Dev Pool (3x burst)</th>
<th>Pro Pool (2x burst)</th>
<th>Scale Pool (1.5x burst)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>requests.cpu</code></td>
<td>4</td>
<td>8</td>
<td>16</td>
</tr>
<tr>
<td><code>limits.cpu</code></td>
<td>12</td>
<td>16</td>
<td>24</td>
</tr>
<tr>
<td><code>requests.memory</code></td>
<td>8Gi</td>
<td>24Gi</td>
<td>64Gi</td>
</tr>
<tr>
<td><code>limits.memory</code></td>
<td>24Gi</td>
<td>48Gi</td>
<td>96Gi</td>
</tr>
<tr>
<td><code>requests.storage</code></td>
<td>60Gi</td>
<td>160Gi</td>
<td>500Gi</td>
</tr>
<tr>
<td><code>pods</code></td>
<td>100</td>
<td>200</td>
<td>500</td>
</tr>
<tr>
<td><code>services.loadbalancers</code></td>
<td>3</td>
<td>5</td>
<td>10</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-implementation-plan">4. Implementation Plan<a class="headerlink" href="#4-implementation-plan" title="Permanent link"> ¶</a></h2>
<h3 id="phase-1-hnc-installation-configuration">Phase 1: HNC Installation &amp; Configuration<a class="headerlink" href="#phase-1-hnc-installation-configuration" title="Permanent link"> ¶</a></h3>
<h4 id="411-install-hnc-controller">4.1.1 Install HNC Controller<a class="headerlink" href="#411-install-hnc-controller" title="Permanent link"> ¶</a></h4>
<p>Add HNC deployment to the Kube-DC installer (<code>installer/kube-dc/templates/</code>):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Install HNC controller</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://github.com/pfnet/hierarchical-namespaces/releases/download/v1.1.0-pfnet.10/default.yaml
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># Install HRQ component (separate manifest)</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://github.com/pfnet/hierarchical-namespaces/releases/download/v1.1.0-pfnet.10/hrq.yaml
</span></code></pre></div>
<p><strong>Helm chart integration:</strong>
- Add HNC manifests to <code>charts/kube-dc/templates/</code> or as a dependency
- Configure HNC via <code>HNCConfiguration</code> resource to propagate relevant resource types</p>
<h4 id="412-hnc-configuration">4.1.2 HNC Configuration<a class="headerlink" href="#412-hnc-configuration" title="Permanent link"> ¶</a></h4>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hnc.x-k8s.io/v1alpha2</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HNCConfiguration</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="c1"># Propagate RBAC (HNC default)</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">roles.rbac.authorization.k8s.io</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Propagate</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rolebindings.rbac.authorization.k8s.io</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Propagate</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="c1"># Do NOT propagate Kube-DC CRDs (managed by controllers)</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projects.kube-dc.com</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ignore</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">organizations.kube-dc.com</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ignore</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">    </span><span class="c1"># Propagate secrets for shared credentials</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secrets</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Propagate</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="c1"># Propagate LimitRange from org namespace to project namespaces</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">    </span><span class="c1"># CRITICAL: Required for HRQ enforcement — without LimitRange, pods</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">    </span><span class="c1"># without explicit resource requests will be REJECTED by ResourceQuota</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">limitranges</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Propagate</span>
</span></code></pre></div>
<h4 id="413-rbac-for-hnc-resources">4.1.3 RBAC for HNC Resources<a class="headerlink" href="#413-rbac-for-hnc-resources" title="Permanent link"> ¶</a></h4>
<p>The kube-dc-manager service account needs permissions to manage HNC resources:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Add to existing ClusterRole or create new one</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-dc-hnc-manager</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hnc.x-k8s.io&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hierarchicalresourcequotas&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;hierarchyconfigurations&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;subnamespaceanchors&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hnc.x-k8s.io&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hierarchicalresourcequotas/status&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<h3 id="phase-2-controller-changes-go">Phase 2: Controller Changes (Go)<a class="headerlink" href="#phase-2-controller-changes-go" title="Permanent link"> ¶</a></h3>
<h4 id="421-project-controller-set-namespace-parent">4.2.1 Project Controller — Set Namespace Parent<a class="headerlink" href="#421-project-controller-set-namespace-parent" title="Permanent link"> ¶</a></h4>
<p><strong>File:</strong> <code>internal/project/res_namespace.go</code></p>
<p>When creating a project namespace, set the HNC parent relationship:</p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewProjectNamespace</span><span class="p">(</span><span class="nx">cli</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">project</span><span class="w"> </span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Project</span><span class="p">,</span><span class="w"> </span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">logr</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">objmgr</span><span class="p">.</span><span class="nx">KubeDcResource</span><span class="p">[</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="nx">genObject</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">{</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">        </span><span class="nx">ObjectMeta</span><span class="p">:</span><span class="w"> </span><span class="nx">v1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">            </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">ProjectNamespaceName</span><span class="p">(</span><span class="nx">project</span><span class="p">),</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">            </span><span class="nx">Annotations</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">                </span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">ProjectNamespaceAnnotationKey</span><span class="p">:</span><span class="w"> </span><span class="nx">nsProjAnnotation</span><span class="p">(</span><span class="nx">project</span><span class="p">),</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">            </span><span class="nx">Labels</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">                </span><span class="c1">// HNC will set tree labels automatically once hierarchy is configured</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span><span class="c1">// ... existing diff function ...</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>New file:</strong> <code>internal/project/res_hierarchy.go</code></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">project</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1">// Create/update HierarchyConfiguration to set parent namespace</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewProjectHierarchy</span><span class="p">(</span><span class="nx">cli</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">project</span><span class="w"> </span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Project</span><span class="p">,</span><span class="w"> </span><span class="nx">l</span><span class="w"> </span><span class="o">*</span><span class="nx">logr</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">objmgr</span><span class="p">.</span><span class="nx">KubeDcResource</span><span class="p">[</span><span class="o">*</span><span class="nx">hncv1alpha2</span><span class="p">.</span><span class="nx">HierarchyConfiguration</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">    </span><span class="nx">genObject</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">hncv1alpha2</span><span class="p">.</span><span class="nx">HierarchyConfiguration</span><span class="p">{</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">        </span><span class="nx">ObjectMeta</span><span class="p">:</span><span class="w"> </span><span class="nx">v1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">            </span><span class="nx">Name</span><span class="p">:</span><span class="w">      </span><span class="s">&quot;hierarchy&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// HNC requires this exact name</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">            </span><span class="nx">Namespace</span><span class="p">:</span><span class="w"> </span><span class="nx">ProjectNamespaceName</span><span class="p">(</span><span class="nx">project</span><span class="p">),</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">        </span><span class="nx">Spec</span><span class="p">:</span><span class="w"> </span><span class="nx">hncv1alpha2</span><span class="p">.</span><span class="nx">HierarchyConfigurationSpec</span><span class="p">{</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">            </span><span class="nx">Parent</span><span class="p">:</span><span class="w"> </span><span class="nx">project</span><span class="p">.</span><span class="nx">Organization</span><span class="p">().</span><span class="nx">Namespace</span><span class="p">,</span><span class="w"> </span><span class="c1">// org namespace as parent</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Integration in <code>internal/project/project.go</code> Sync():</strong>
<div class="language-go highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">// After namespace creation, before VPC creation:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;create or update HNC Hierarchy&quot;</span><span class="p">)</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="nx">hierarchy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewProjectHierarchy</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hierarchy</span><span class="p">.</span><span class="nx">Sync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="nx">projectStatusChanged</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">projectStatusChanged</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">hierarchy</span><span class="p">.</span><span class="nx">StatusChanged</span><span class="p">()</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">projectStatusChanged</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="p">}</span>
</span></code></pre></div></p>
<h4 id="422-organization-controller-manage-hrq">4.2.2 Organization Controller — Manage HRQ<a class="headerlink" href="#422-organization-controller-manage-hrq" title="Permanent link"> ¶</a></h4>
<p><strong>New file:</strong> <code>internal/organization/res_hrq.go</code></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">organization</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="nx">hncv1alpha2</span><span class="w"> </span><span class="s">&quot;sigs.k8s.io/hierarchical-namespaces/api/v1alpha2&quot;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/api/resource&quot;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="p">)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="nx">HRQName</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;plan-quota&quot;</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="nx">HRQManagedLabel</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;billing.kube-dc.com/managed&quot;</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">    </span><span class="nx">HRQPlanIdLabel</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;billing.kube-dc.com/plan-id&quot;</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="p">)</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="c1">// PlanResources holds computed resource limits for an organization</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="kd">type</span><span class="w"> </span><span class="nx">PlanResources</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="nx">RequestsCPU</span><span class="w">       </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="nx">RequestsMemory</span><span class="w">    </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">    </span><span class="nx">LimitsCPU</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">    </span><span class="nx">LimitsMemory</span><span class="w">      </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">    </span><span class="nx">RequestsStorage</span><span class="w">   </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">    </span><span class="nx">Pods</span><span class="w">              </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">    </span><span class="nx">ServicesLB</span><span class="w">        </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="p">}</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewOrganizationHRQ</span><span class="p">(</span><span class="nx">cli</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="w"> </span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Organization</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">    </span><span class="nx">planResources</span><span class="w"> </span><span class="o">*</span><span class="nx">PlanResources</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">logr</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">objmgr</span><span class="p">.</span><span class="nx">KubeDcResource</span><span class="p">[</span><span class="o">*</span><span class="nx">hncv1alpha2</span><span class="p">.</span><span class="nx">HierarchicalResourceQuota</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">planResources</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="c1">// No plan = no HRQ</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="w">    </span><span class="nx">genObject</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">hncv1alpha2</span><span class="p">.</span><span class="nx">HierarchicalResourceQuota</span><span class="p">{</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="w">        </span><span class="nx">ObjectMeta</span><span class="p">:</span><span class="w"> </span><span class="nx">v1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="w">            </span><span class="nx">Name</span><span class="p">:</span><span class="w">      </span><span class="nx">HRQName</span><span class="p">,</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="w">            </span><span class="nx">Namespace</span><span class="p">:</span><span class="w"> </span><span class="nx">org</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="w">            </span><span class="nx">Labels</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="w">                </span><span class="nx">HRQManagedLabel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="w">        </span><span class="nx">Spec</span><span class="p">:</span><span class="w"> </span><span class="nx">hncv1alpha2</span><span class="p">.</span><span class="nx">HierarchicalResourceQuotaSpec</span><span class="p">{</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">            </span><span class="nx">Hard</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="w">                </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceRequestsCPU</span><span class="p">:</span><span class="w">    </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">RequestsCPU</span><span class="p">,</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">                </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceRequestsMemory</span><span class="p">:</span><span class="w"> </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">RequestsMemory</span><span class="p">,</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="w">                </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceLimitsCPU</span><span class="p">:</span><span class="w">      </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">LimitsCPU</span><span class="p">,</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="w">                </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceLimitsMemory</span><span class="p">:</span><span class="w">   </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">LimitsMemory</span><span class="p">,</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="w">                </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceRequestsStorage</span><span class="p">:</span><span class="w"> </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">RequestsStorage</span><span class="p">,</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a><span class="w">                </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourcePods</span><span class="p">:</span><span class="w">           </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">Pods</span><span class="p">,</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a><span class="w">                </span><span class="s">&quot;services.loadbalancers&quot;</span><span class="p">:</span><span class="w">      </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">ServicesLB</span><span class="p">,</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Reading plan from Organization annotations:</strong></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">GetPlanResourcesFromAnnotations</span><span class="p">(</span><span class="nx">org</span><span class="w"> </span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Organization</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">PlanResources</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="nx">annotations</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">org</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">annotations</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">    </span><span class="nx">planId</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">annotations</span><span class="p">[</span><span class="s">&quot;billing.kube-dc.com/plan-id&quot;</span><span class="p">]</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="nx">status</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">annotations</span><span class="p">[</span><span class="s">&quot;billing.kube-dc.com/subscription&quot;</span><span class="p">]</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">    </span><span class="c1">// Active statuses that should have full HRQ (see §7.2 state machine)</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">planId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;trialing&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;canceling&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="c1">// Plan definitions (should match subscriptionController.js SUBSCRIPTION_PLANS)</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">    </span><span class="nx">plans</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">PlanResources</span><span class="p">{</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">        </span><span class="s">&quot;dev-pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">            </span><span class="nx">RequestsCPU</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;4&quot;</span><span class="p">),</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">            </span><span class="nx">RequestsMemory</span><span class="p">:</span><span class="w">  </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;8Gi&quot;</span><span class="p">),</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">            </span><span class="nx">LimitsCPU</span><span class="p">:</span><span class="w">       </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;12&quot;</span><span class="p">),</span><span class="w">   </span><span class="c1">// 3x burst (see §3.6)</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">            </span><span class="nx">LimitsMemory</span><span class="p">:</span><span class="w">    </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;24Gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">// 3x burst</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">            </span><span class="nx">RequestsStorage</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;60Gi&quot;</span><span class="p">),</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">            </span><span class="nx">Pods</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;100&quot;</span><span class="p">),</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">            </span><span class="nx">ServicesLB</span><span class="p">:</span><span class="w">      </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">),</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">        </span><span class="s">&quot;pro-pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="s">&quot;scale-pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">    </span><span class="nx">base</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">plans</span><span class="p">[</span><span class="nx">planId</span><span class="p">]</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">    </span><span class="c1">// Apply add-ons</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">    </span><span class="nx">addonsJSON</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">annotations</span><span class="p">[</span><span class="s">&quot;billing.kube-dc.com/addons&quot;</span><span class="p">]</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="w">    </span><span class="c1">// Parse and add addon resources to base...</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">base</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="423-organization-controller-watch-annotation-changes">4.2.3 Organization Controller — Watch Annotation Changes<a class="headerlink" href="#423-organization-controller-watch-annotation-changes" title="Permanent link"> ¶</a></h4>
<p><strong>File:</strong> <code>internal/controller/kube-dc.com/organization_controller.go</code></p>
<p>Update the predicate to trigger reconciliation on annotation changes (billing events):</p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">getPredicateFuncOrg</span><span class="p">()</span><span class="w"> </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">Funcs</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">Funcs</span><span class="p">{</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">        </span><span class="nx">UpdateFunc</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">UpdateEvent</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">            </span><span class="nx">oldObj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">ObjectOld</span><span class="p">.(</span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Organization</span><span class="p">)</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">            </span><span class="nx">newObj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">ObjectNew</span><span class="p">.(</span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Organization</span><span class="p">)</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">            </span><span class="c1">// Existing spec/finalizer/deletion checks...</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">            </span><span class="c1">// NEW: Check if billing annotations changed</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">            </span><span class="nx">oldPlanId</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldObj</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/plan-id&quot;</span><span class="p">]</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">            </span><span class="nx">newPlanId</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newObj</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/plan-id&quot;</span><span class="p">]</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">            </span><span class="nx">oldAddons</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldObj</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/addons&quot;</span><span class="p">]</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">            </span><span class="nx">newAddons</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newObj</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/addons&quot;</span><span class="p">]</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">            </span><span class="nx">oldStatus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldObj</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/subscription&quot;</span><span class="p">]</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">            </span><span class="nx">newStatus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newObj</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/subscription&quot;</span><span class="p">]</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">oldPlanId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">newPlanId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">oldAddons</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">newAddons</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">oldStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">newStatus</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c1">// Reconcile to update HRQ</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">            </span><span class="c1">// ... existing checks</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="424-organization-controller-manage-limitrange">4.2.4 Organization Controller — Manage LimitRange<a class="headerlink" href="#424-organization-controller-manage-limitrange" title="Permanent link"> ¶</a></h4>
<p><strong>New file:</strong> <code>internal/organization/res_limitrange.go</code></p>
<p>The LimitRange is created in the org namespace. HNC propagates it to all child project namespaces automatically.</p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">organization</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="nx">corev1</span><span class="w"> </span><span class="s">&quot;k8s.io/api/core/v1&quot;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="s">&quot;k8s.io/apimachinery/pkg/api/resource&quot;</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="p">)</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">    </span><span class="nx">LimitRangeName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;default-resource-limits&quot;</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="p">)</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="c1">// LimitRangeDefaults holds default/max resource values per plan</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="kd">type</span><span class="w"> </span><span class="nx">LimitRangeDefaults</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">    </span><span class="nx">DefaultCPU</span><span class="w">        </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">    </span><span class="nx">DefaultMemory</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">    </span><span class="nx">DefaultRequestCPU</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">    </span><span class="nx">DefaultRequestMem</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">    </span><span class="nx">MaxCPU</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">    </span><span class="nx">MaxMemory</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">    </span><span class="nx">MinCPU</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="w">    </span><span class="nx">MinMemory</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">    </span><span class="nx">MaxPodCPU</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">    </span><span class="nx">MaxPodMemory</span><span class="w">      </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="w">    </span><span class="nx">MaxPVCStorage</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">    </span><span class="nx">MinPVCStorage</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="p">}</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="kd">func</span><span class="w"> </span><span class="nx">GetLimitRangeDefaultsForPlan</span><span class="p">(</span><span class="nx">planId</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">LimitRangeDefaults</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">    </span><span class="nx">defaults</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">LimitRangeDefaults</span><span class="p">{</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">        </span><span class="s">&quot;dev-pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">            </span><span class="nx">DefaultCPU</span><span class="p">:</span><span class="w">        </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;500m&quot;</span><span class="p">),</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">            </span><span class="nx">DefaultMemory</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;512Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="w">            </span><span class="nx">DefaultRequestCPU</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;100m&quot;</span><span class="p">),</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="w">            </span><span class="nx">DefaultRequestMem</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;128Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="w">            </span><span class="nx">MaxCPU</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">),</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="w">            </span><span class="nx">MaxMemory</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;4Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="w">            </span><span class="nx">MinCPU</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;10m&quot;</span><span class="p">),</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="w">            </span><span class="nx">MinMemory</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;16Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="w">            </span><span class="nx">MaxPodCPU</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;4&quot;</span><span class="p">),</span>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="w">            </span><span class="nx">MaxPodMemory</span><span class="p">:</span><span class="w">      </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;8Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="w">            </span><span class="nx">MaxPVCStorage</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;60Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="w">            </span><span class="nx">MinPVCStorage</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;1Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a><span class="w">        </span><span class="s">&quot;pro-pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a><span class="w">            </span><span class="nx">DefaultCPU</span><span class="p">:</span><span class="w">        </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;500m&quot;</span><span class="p">),</span>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a><span class="w">            </span><span class="nx">DefaultMemory</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;512Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="w">            </span><span class="nx">DefaultRequestCPU</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;250m&quot;</span><span class="p">),</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a><span class="w">            </span><span class="nx">DefaultRequestMem</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;256Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a><span class="w">            </span><span class="nx">MaxCPU</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;4&quot;</span><span class="p">),</span>
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a><span class="w">            </span><span class="nx">MaxMemory</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;12Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a><span class="w">            </span><span class="nx">MinCPU</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;10m&quot;</span><span class="p">),</span>
</span><span id="__span-24-52"><a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a><span class="w">            </span><span class="nx">MinMemory</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;16Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-53"><a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a><span class="w">            </span><span class="nx">MaxPodCPU</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;8&quot;</span><span class="p">),</span>
</span><span id="__span-24-54"><a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a><span class="w">            </span><span class="nx">MaxPodMemory</span><span class="p">:</span><span class="w">      </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;24Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-55"><a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a><span class="w">            </span><span class="nx">MaxPVCStorage</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;160Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-56"><a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a><span class="w">            </span><span class="nx">MinPVCStorage</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;1Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-57"><a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-24-58"><a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a><span class="w">        </span><span class="s">&quot;scale-pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-59"><a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a><span class="w">            </span><span class="nx">DefaultCPU</span><span class="p">:</span><span class="w">        </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">),</span>
</span><span id="__span-24-60"><a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a><span class="w">            </span><span class="nx">DefaultMemory</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;1Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-61"><a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a><span class="w">            </span><span class="nx">DefaultRequestCPU</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;500m&quot;</span><span class="p">),</span>
</span><span id="__span-24-62"><a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a><span class="w">            </span><span class="nx">DefaultRequestMem</span><span class="p">:</span><span class="w"> </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;512Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-63"><a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a><span class="w">            </span><span class="nx">MaxCPU</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;8&quot;</span><span class="p">),</span>
</span><span id="__span-24-64"><a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a><span class="w">            </span><span class="nx">MaxMemory</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;32Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-65"><a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a><span class="w">            </span><span class="nx">MinCPU</span><span class="p">:</span><span class="w">            </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;10m&quot;</span><span class="p">),</span>
</span><span id="__span-24-66"><a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a><span class="w">            </span><span class="nx">MinMemory</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;16Mi&quot;</span><span class="p">),</span>
</span><span id="__span-24-67"><a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a><span class="w">            </span><span class="nx">MaxPodCPU</span><span class="p">:</span><span class="w">         </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;16&quot;</span><span class="p">),</span>
</span><span id="__span-24-68"><a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a><span class="w">            </span><span class="nx">MaxPodMemory</span><span class="p">:</span><span class="w">      </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;56Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-69"><a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a><span class="w">            </span><span class="nx">MaxPVCStorage</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;320Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-70"><a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a><span class="w">            </span><span class="nx">MinPVCStorage</span><span class="p">:</span><span class="w">     </span><span class="nx">resource</span><span class="p">.</span><span class="nx">MustParse</span><span class="p">(</span><span class="s">&quot;1Gi&quot;</span><span class="p">),</span>
</span><span id="__span-24-71"><a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-24-72"><a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-73"><a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a><span class="w">    </span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">defaults</span><span class="p">[</span><span class="nx">planId</span><span class="p">]</span>
</span><span id="__span-24-74"><a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-75"><a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-24-76"><a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-77"><a id="__codelineno-24-77" name="__codelineno-24-77" href="#__codelineno-24-77"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">d</span>
</span><span id="__span-24-78"><a id="__codelineno-24-78" name="__codelineno-24-78" href="#__codelineno-24-78"></a><span class="p">}</span>
</span><span id="__span-24-79"><a id="__codelineno-24-79" name="__codelineno-24-79" href="#__codelineno-24-79"></a>
</span><span id="__span-24-80"><a id="__codelineno-24-80" name="__codelineno-24-80" href="#__codelineno-24-80"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewOrganizationLimitRange</span><span class="p">(</span><span class="nx">cli</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="w"> </span><span class="o">*</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Organization</span><span class="p">,</span>
</span><span id="__span-24-81"><a id="__codelineno-24-81" name="__codelineno-24-81" href="#__codelineno-24-81"></a><span class="w">    </span><span class="nx">lrDefaults</span><span class="w"> </span><span class="o">*</span><span class="nx">LimitRangeDefaults</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="w"> </span><span class="o">*</span><span class="nx">logr</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span><span class="w"> </span><span class="nx">objmgr</span><span class="p">.</span><span class="nx">KubeDcResource</span><span class="p">[</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitRange</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-82"><a id="__codelineno-24-82" name="__codelineno-24-82" href="#__codelineno-24-82"></a>
</span><span id="__span-24-83"><a id="__codelineno-24-83" name="__codelineno-24-83" href="#__codelineno-24-83"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-84"><a id="__codelineno-24-84" name="__codelineno-24-84" href="#__codelineno-24-84"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-24-85"><a id="__codelineno-24-85" name="__codelineno-24-85" href="#__codelineno-24-85"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-86"><a id="__codelineno-24-86" name="__codelineno-24-86" href="#__codelineno-24-86"></a>
</span><span id="__span-24-87"><a id="__codelineno-24-87" name="__codelineno-24-87" href="#__codelineno-24-87"></a><span class="w">    </span><span class="nx">genObject</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitRange</span><span class="p">{</span>
</span><span id="__span-24-88"><a id="__codelineno-24-88" name="__codelineno-24-88" href="#__codelineno-24-88"></a><span class="w">        </span><span class="nx">ObjectMeta</span><span class="p">:</span><span class="w"> </span><span class="nx">v1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span><span id="__span-24-89"><a id="__codelineno-24-89" name="__codelineno-24-89" href="#__codelineno-24-89"></a><span class="w">            </span><span class="nx">Name</span><span class="p">:</span><span class="w">      </span><span class="nx">LimitRangeName</span><span class="p">,</span>
</span><span id="__span-24-90"><a id="__codelineno-24-90" name="__codelineno-24-90" href="#__codelineno-24-90"></a><span class="w">            </span><span class="nx">Namespace</span><span class="p">:</span><span class="w"> </span><span class="nx">org</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span><span id="__span-24-91"><a id="__codelineno-24-91" name="__codelineno-24-91" href="#__codelineno-24-91"></a><span class="w">            </span><span class="nx">Labels</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-24-92"><a id="__codelineno-24-92" name="__codelineno-24-92" href="#__codelineno-24-92"></a><span class="w">                </span><span class="nx">HRQManagedLabel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span>
</span><span id="__span-24-93"><a id="__codelineno-24-93" name="__codelineno-24-93" href="#__codelineno-24-93"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-24-94"><a id="__codelineno-24-94" name="__codelineno-24-94" href="#__codelineno-24-94"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-24-95"><a id="__codelineno-24-95" name="__codelineno-24-95" href="#__codelineno-24-95"></a><span class="w">        </span><span class="nx">Spec</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitRangeSpec</span><span class="p">{</span>
</span><span id="__span-24-96"><a id="__codelineno-24-96" name="__codelineno-24-96" href="#__codelineno-24-96"></a><span class="w">            </span><span class="nx">Limits</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitRangeItem</span><span class="p">{</span>
</span><span id="__span-24-97"><a id="__codelineno-24-97" name="__codelineno-24-97" href="#__codelineno-24-97"></a><span class="w">                </span><span class="p">{</span>
</span><span id="__span-24-98"><a id="__codelineno-24-98" name="__codelineno-24-98" href="#__codelineno-24-98"></a><span class="w">                    </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitTypeContainer</span><span class="p">,</span>
</span><span id="__span-24-99"><a id="__codelineno-24-99" name="__codelineno-24-99" href="#__codelineno-24-99"></a><span class="w">                    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-100"><a id="__codelineno-24-100" name="__codelineno-24-100" href="#__codelineno-24-100"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">:</span><span class="w">    </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">DefaultCPU</span><span class="p">,</span>
</span><span id="__span-24-101"><a id="__codelineno-24-101" name="__codelineno-24-101" href="#__codelineno-24-101"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">DefaultMemory</span><span class="p">,</span>
</span><span id="__span-24-102"><a id="__codelineno-24-102" name="__codelineno-24-102" href="#__codelineno-24-102"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-103"><a id="__codelineno-24-103" name="__codelineno-24-103" href="#__codelineno-24-103"></a><span class="w">                    </span><span class="nx">DefaultRequest</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-104"><a id="__codelineno-24-104" name="__codelineno-24-104" href="#__codelineno-24-104"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">:</span><span class="w">    </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">DefaultRequestCPU</span><span class="p">,</span>
</span><span id="__span-24-105"><a id="__codelineno-24-105" name="__codelineno-24-105" href="#__codelineno-24-105"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">DefaultRequestMem</span><span class="p">,</span>
</span><span id="__span-24-106"><a id="__codelineno-24-106" name="__codelineno-24-106" href="#__codelineno-24-106"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-107"><a id="__codelineno-24-107" name="__codelineno-24-107" href="#__codelineno-24-107"></a><span class="w">                    </span><span class="nx">Max</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-108"><a id="__codelineno-24-108" name="__codelineno-24-108" href="#__codelineno-24-108"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">:</span><span class="w">    </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MaxCPU</span><span class="p">,</span>
</span><span id="__span-24-109"><a id="__codelineno-24-109" name="__codelineno-24-109" href="#__codelineno-24-109"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MaxMemory</span><span class="p">,</span>
</span><span id="__span-24-110"><a id="__codelineno-24-110" name="__codelineno-24-110" href="#__codelineno-24-110"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-111"><a id="__codelineno-24-111" name="__codelineno-24-111" href="#__codelineno-24-111"></a><span class="w">                    </span><span class="nx">Min</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-112"><a id="__codelineno-24-112" name="__codelineno-24-112" href="#__codelineno-24-112"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">:</span><span class="w">    </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MinCPU</span><span class="p">,</span>
</span><span id="__span-24-113"><a id="__codelineno-24-113" name="__codelineno-24-113" href="#__codelineno-24-113"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MinMemory</span><span class="p">,</span>
</span><span id="__span-24-114"><a id="__codelineno-24-114" name="__codelineno-24-114" href="#__codelineno-24-114"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-115"><a id="__codelineno-24-115" name="__codelineno-24-115" href="#__codelineno-24-115"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-24-116"><a id="__codelineno-24-116" name="__codelineno-24-116" href="#__codelineno-24-116"></a><span class="w">                </span><span class="p">{</span>
</span><span id="__span-24-117"><a id="__codelineno-24-117" name="__codelineno-24-117" href="#__codelineno-24-117"></a><span class="w">                    </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitTypePod</span><span class="p">,</span>
</span><span id="__span-24-118"><a id="__codelineno-24-118" name="__codelineno-24-118" href="#__codelineno-24-118"></a><span class="w">                    </span><span class="nx">Max</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-119"><a id="__codelineno-24-119" name="__codelineno-24-119" href="#__codelineno-24-119"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">:</span><span class="w">    </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MaxPodCPU</span><span class="p">,</span>
</span><span id="__span-24-120"><a id="__codelineno-24-120" name="__codelineno-24-120" href="#__codelineno-24-120"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MaxPodMemory</span><span class="p">,</span>
</span><span id="__span-24-121"><a id="__codelineno-24-121" name="__codelineno-24-121" href="#__codelineno-24-121"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-122"><a id="__codelineno-24-122" name="__codelineno-24-122" href="#__codelineno-24-122"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-24-123"><a id="__codelineno-24-123" name="__codelineno-24-123" href="#__codelineno-24-123"></a><span class="w">                </span><span class="p">{</span>
</span><span id="__span-24-124"><a id="__codelineno-24-124" name="__codelineno-24-124" href="#__codelineno-24-124"></a><span class="w">                    </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">LimitTypePersistentVolumeClaim</span><span class="p">,</span>
</span><span id="__span-24-125"><a id="__codelineno-24-125" name="__codelineno-24-125" href="#__codelineno-24-125"></a><span class="w">                    </span><span class="nx">Max</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-126"><a id="__codelineno-24-126" name="__codelineno-24-126" href="#__codelineno-24-126"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceStorage</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MaxPVCStorage</span><span class="p">,</span>
</span><span id="__span-24-127"><a id="__codelineno-24-127" name="__codelineno-24-127" href="#__codelineno-24-127"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-128"><a id="__codelineno-24-128" name="__codelineno-24-128" href="#__codelineno-24-128"></a><span class="w">                    </span><span class="nx">Min</span><span class="p">:</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span><span id="__span-24-129"><a id="__codelineno-24-129" name="__codelineno-24-129" href="#__codelineno-24-129"></a><span class="w">                        </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceStorage</span><span class="p">:</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">.</span><span class="nx">MinPVCStorage</span><span class="p">,</span>
</span><span id="__span-24-130"><a id="__codelineno-24-130" name="__codelineno-24-130" href="#__codelineno-24-130"></a><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-24-131"><a id="__codelineno-24-131" name="__codelineno-24-131" href="#__codelineno-24-131"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-24-132"><a id="__codelineno-24-132" name="__codelineno-24-132" href="#__codelineno-24-132"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-24-133"><a id="__codelineno-24-133" name="__codelineno-24-133" href="#__codelineno-24-133"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-24-134"><a id="__codelineno-24-134" name="__codelineno-24-134" href="#__codelineno-24-134"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-135"><a id="__codelineno-24-135" name="__codelineno-24-135" href="#__codelineno-24-135"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-24-136"><a id="__codelineno-24-136" name="__codelineno-24-136" href="#__codelineno-24-136"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Update <code>organization.Sync()</code> in <code>internal/organization/organization.go</code>:</strong></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// After existing sync steps, add HRQ and LimitRange sync:</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nx">log</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;Sync hierarchical resource quota...&quot;</span><span class="p">)</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nx">planResources</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GetPlanResourcesFromAnnotations</span><span class="p">(</span><span class="nx">org</span><span class="p">)</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="k">if</span><span class="w"> </span><span class="nx">planResources</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="nx">hrqRes</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewOrganizationHRQ</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">planResources</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hrqRes</span><span class="p">.</span><span class="nx">Sync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="nx">orgStatusChanged</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">orgStatusChanged</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">hrqRes</span><span class="p">.</span><span class="nx">StatusChanged</span><span class="p">()</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">orgStatusChanged</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="p">}</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="c1">// LimitRange MUST be synced alongside HRQ — without it, pods without</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="c1">// explicit resource requests will be rejected by the ResourceQuota</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="c1">// that HRQ creates internally in each child namespace.</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="c1">// The LimitRange is created in the org namespace and HNC propagates</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="c1">// it to all project namespaces automatically.</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="nx">log</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;Sync LimitRange for default resource requests...&quot;</span><span class="p">)</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="nx">planId</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">org</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/plan-id&quot;</span><span class="p">]</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="nx">lrDefaults</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GetLimitRangeDefaultsForPlan</span><span class="p">(</span><span class="nx">planId</span><span class="p">)</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="k">if</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span><span class="nx">lrRes</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewOrganizationLimitRange</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">lrDefaults</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">lrRes</span><span class="p">.</span><span class="nx">Sync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">    </span><span class="nx">orgStatusChanged</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">orgStatusChanged</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">lrRes</span><span class="p">.</span><span class="nx">StatusChanged</span><span class="p">()</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">orgStatusChanged</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="phase-3-backend-changes-nodejs">Phase 3: Backend Changes (Node.js)<a class="headerlink" href="#phase-3-backend-changes-nodejs" title="Permanent link"> ¶</a></h3>
<h4 id="431-subscription-controller-createupdate-hrq-on-plan-change">4.3.1 Subscription Controller — Create/Update HRQ on Plan Change<a class="headerlink" href="#431-subscription-controller-createupdate-hrq-on-plan-change" title="Permanent link"> ¶</a></h4>
<p><strong>File:</strong> <code>ui/backend/controllers/billing/subscriptionController.js</code></p>
<p>After updating Organization annotations (in <code>updateOrganizationSubscription</code>), the Go controller will automatically reconcile and create/update the HRQ. <strong>No direct HRQ manipulation needed from the backend</strong> — the Go controller watches annotation changes.</p>
<p>However, we need to update the <strong>usage endpoint</strong> to read real HRQ status:</p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="cm">/**</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="cm"> * Get real quota usage from HierarchicalResourceQuota status</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="cm"> */</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getOrganizationQuotaUsage</span><span class="p">(</span><span class="nx">organization</span><span class="p">,</span><span class="w"> </span><span class="nx">saToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">hrqUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://</span><span class="si">${</span><span class="nb">global</span><span class="p">.</span><span class="nx">k8sUrl</span><span class="si">}</span><span class="sb">/apis/hnc.x-k8s.io/v1alpha2/namespaces/</span><span class="si">${</span><span class="nx">organization</span><span class="si">}</span><span class="sb">/hierarchicalresourcequotas/plan-quota`</span><span class="p">;</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">hrqUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">                </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">                </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">saToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">            </span><span class="nx">agent</span><span class="o">:</span><span class="w"> </span><span class="nx">httpsAgent</span><span class="p">,</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">// HRQ not found (no plan)</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">hrq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">hard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hrq</span><span class="p">.</span><span class="nx">status</span><span class="o">?</span><span class="p">.</span><span class="nx">hard</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hrq</span><span class="p">.</span><span class="nx">status</span><span class="o">?</span><span class="p">.</span><span class="nx">used</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">            </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">                </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nx">parseCpuValue</span><span class="p">(</span><span class="nx">used</span><span class="p">[</span><span class="s1">&#39;requests.cpu&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">                </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">parseCpuValue</span><span class="p">(</span><span class="nx">hard</span><span class="p">[</span><span class="s1">&#39;requests.cpu&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">            </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">                </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nx">parseMemoryValue</span><span class="p">(</span><span class="nx">used</span><span class="p">[</span><span class="s1">&#39;requests.memory&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">                </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">parseMemoryValue</span><span class="p">(</span><span class="nx">hard</span><span class="p">[</span><span class="s1">&#39;requests.memory&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">            </span><span class="nx">storage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">                </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nx">parseMemoryValue</span><span class="p">(</span><span class="nx">used</span><span class="p">[</span><span class="s1">&#39;requests.storage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="w">                </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">parseMemoryValue</span><span class="p">(</span><span class="nx">hard</span><span class="p">[</span><span class="s1">&#39;requests.storage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">            </span><span class="nx">pods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">                </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">used</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">                </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">hard</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">        </span><span class="p">};</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching HRQ usage:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Replace mock usage in <code>getOrganizationSubscriptionData()</code>:</strong></p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1">// BEFORE (mock):</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">totalCpu</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">totalMemory</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="nx">storage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">totalStorage</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="nx">pods</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="c1">// AFTER (real):</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getOrganizationQuotaUsage</span><span class="p">(</span><span class="nx">organization</span><span class="p">,</span><span class="w"> </span><span class="nx">saToken</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span></code></pre></div>
<h3 id="phase-4-frontend-changes-reacttypescript">Phase 4: Frontend Changes (React/TypeScript)<a class="headerlink" href="#phase-4-frontend-changes-reacttypescript" title="Permanent link"> ¶</a></h3>
<h4 id="441-billing-overview-show-real-usage">4.4.1 Billing Overview — Show Real Usage<a class="headerlink" href="#441-billing-overview-show-real-usage" title="Permanent link"> ¶</a></h4>
<p><strong>File:</strong> <code>ui/frontend/src/app/ManageOrganization/Billing/Billing.tsx</code></p>
<p>The <code>QuotaUsage</code> type already exists in <code>types.ts</code> and matches the HRQ data shape. The overview tab already renders usage bars. The primary change is that the backend now returns real data instead of zeros.</p>
<p>Additional UI improvements:
- Show "Quota enforcement: Active" badge when HRQ exists
- Warning alerts when usage exceeds 80% of limits
- Error alerts when pods fail scheduling due to quota</p>
<h4 id="442-plan-selection-show-quota-impact">4.4.2 Plan Selection — Show Quota Impact<a class="headerlink" href="#442-plan-selection-show-quota-impact" title="Permanent link"> ¶</a></h4>
<p><strong>File:</strong> <code>ui/frontend/src/app/ManageOrganization/Billing/SubscribePlanModal.tsx</code></p>
<p>When changing plans, show:
- Current usage vs new plan limits
- Warning if downgrade would exceed new limits
- Confirmation dialog for downgrades that would restrict resources</p>
<h3 id="phase-5-subscription-hrq-lifecycle-permission-model">Phase 5: Subscription → HRQ Lifecycle &amp; Permission Model<a class="headerlink" href="#phase-5-subscription-hrq-lifecycle-permission-model" title="Permanent link"> ¶</a></h3>
<h4 id="451-end-to-end-flow-who-changes-what">4.5.1 End-to-End Flow: Who Changes What<a class="headerlink" href="#451-end-to-end-flow-who-changes-what" title="Permanent link"> ¶</a></h4>
<p>Users <strong>cannot</strong> modify HRQ or LimitRange directly — they have no RBAC permissions for these resources. All quota changes flow through a <strong>two-stage indirect reconciliation</strong>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>User / Stripe
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>     │
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>     ▼
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>┌─────────────────────────────────────────────────────┐
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>│  Stage 1: Node.js Backend                           │
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>│  (runs as kube-dc-backend ServiceAccount)           │
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>│                                                     │
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>│  Authenticates via:                                 │
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>│    • User JWT token (UI actions)                    │
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>│    • Stripe webhook signature (Stripe events)       │
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>│                                                     │
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>│  Action: PATCH Organization annotations             │
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>│    billing.kube-dc.com/plan-id: &quot;pro-pool&quot;          │
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>│    billing.kube-dc.com/subscription: &quot;active&quot;       │
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>│    billing.kube-dc.com/addons: [...]                │
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>└──────────────────────┬──────────────────────────────┘
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>                       │ annotation change triggers reconcile
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>                       ▼
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>┌─────────────────────────────────────────────────────┐
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>│  Stage 2: Go Organization Controller                │
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>│  (runs as kube-dc-manager ServiceAccount)           │
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>│                                                     │
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>│  Watches: Organization annotation changes           │
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>│                                                     │
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>│  Action: Create/Update/Delete HRQ + LimitRange      │
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>│    based on billing.kube-dc.com/plan-id annotation  │
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>└─────────────────────────────────────────────────────┘
</span></code></pre></div>
<p><strong>Why this design:</strong>
- <strong>Security:</strong> Users never touch HRQ/LimitRange directly. Only privileged ServiceAccounts can.
- <strong>Stripe is the source of truth:</strong> Payment confirmation (Stripe webhook) → annotations → HRQ. No payment = no quota.
- <strong>Idempotent:</strong> The Go controller reconciles to desired state on every annotation change. If the backend crashes mid-update, the next reconcile fixes it.
- <strong>Auditable:</strong> All changes flow through Organization annotations with timestamps, visible in <code>kubectl describe organization</code>.</p>
<h4 id="452-subscription-flows-in-detail">4.5.2 Subscription Flows in Detail<a class="headerlink" href="#452-subscription-flows-in-detail" title="Permanent link"> ¶</a></h4>
<p><strong>Flow A: New Subscription (user initiates via UI)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>1. User clicks &quot;Subscribe to Pro Pool&quot; in UI
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>2. Frontend POST /api/billing/organization-subscription { planId: &quot;pro-pool&quot; }
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>3. Backend verifies JWT → isOrgAdmin(token)
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>4. Backend creates Stripe Checkout Session (redirect to Stripe payment page)
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>5. User completes payment on Stripe
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>6. Frontend calls POST /api/billing/verify-checkout { sessionId }
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>7. Backend retrieves Stripe session, verifies payment/trial status
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>8. Backend PATCHes Organization annotations (using SA token):
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>     billing.kube-dc.com/subscription: &quot;active&quot;
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>     billing.kube-dc.com/plan-id: &quot;pro-pool&quot;
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>     billing.kube-dc.com/stripe-subscription-id: &quot;sub_...&quot;
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>9. Go controller sees annotation change → reconciles:
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>     → Creates HierarchicalResourceQuota (plan-quota) in org namespace
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>     → Creates LimitRange (default-resource-limits) in org namespace
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>     → HNC propagates LimitRange to all project namespaces
</span></code></pre></div>
<p><strong>Flow B: Plan Change (upgrade/downgrade)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>1. User clicks &quot;Change to Scale Pool&quot; in UI
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>2. Frontend PUT /api/billing/organization-subscription { planId: &quot;scale-pool&quot; }
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>3. Backend verifies JWT → isOrgAdmin(token)
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>4. Backend updates Stripe subscription (proration applied)
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>5. Backend PATCHes Organization annotations:
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>     billing.kube-dc.com/plan-id: &quot;scale-pool&quot;    ← changed
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>6. Go controller sees plan-id changed → reconciles:
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>     → Updates HRQ spec.hard with new plan limits
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>     → Updates auto-managed LimitRange with new plan defaults
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>       (or skips if user has their own LimitRange)
</span></code></pre></div>
<p><strong>Flow C: Cancellation</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>1. User clicks &quot;Cancel Subscription&quot; in UI
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>2. Frontend DELETE /api/billing/organization-subscription
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>3. Backend verifies JWT → isOrgAdmin(token)
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>4. Backend sets Stripe subscription to cancel_at_period_end: true
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>5. Backend PATCHes Organization annotations:
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>     billing.kube-dc.com/subscription: &quot;canceling&quot;   ← not &quot;canceled&quot; yet
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>     billing.kube-dc.com/plan-id: &quot;pro-pool&quot;          ← KEPT until period end
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>6. Go controller sees status=&quot;canceling&quot; → HRQ REMAINS ACTIVE until period end
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>   (user still has quota for the rest of the paid period)
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>--- At billing period end (Stripe fires webhook) ---
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>7. Stripe sends customer.subscription.deleted webhook
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>8. Backend verifies webhook signature (STRIPE_WEBHOOK_SECRET)
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>9. Backend PATCHes Organization annotations (using SA token):
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>     billing.kube-dc.com/subscription: &quot;suspended&quot;    ← grace period starts (see §7.2)
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>     billing.kube-dc.com/suspended-at: &quot;2026-02-07T...&quot; ← timestamp for grace tracking
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>     billing.kube-dc.com/plan-id: &quot;pro-pool&quot;           ← KEPT (for restore reference)
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>10. Go controller sees status=&quot;suspended&quot; → reconciles:
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a>      → Sets HRQ to minimal suspended quota (0.5 CPU, 1Gi)
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>      → Keeps LimitRange (system pods still need defaults)
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>--- After 7-day grace period (cron/controller timer) ---
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>11. Controller checks suspended-at timestamp, 7 days passed → transitions:
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>      billing.kube-dc.com/subscription: &quot;canceled&quot;
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>      billing.kube-dc.com/plan-id: &quot;&quot;                  ← cleared
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>      billing.kube-dc.com/addons: []                   ← cleared
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a>12. Go controller sees status=&quot;canceled&quot; → reconciles:
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>      → Keeps minimal HRQ (system pods)
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>      → Suspends all user workloads (scale to 0, halt VMs)
</span></code></pre></div>
<p><strong>Flow D: Stripe Webhook Events (server-to-server, no user involved)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>Stripe → POST /api/billing/webhook (raw body + Stripe-Signature header)
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>Backend verifies: stripe.webhooks.constructEvent(body, sig, STRIPE_WEBHOOK_SECRET)
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>Backend uses: ServiceAccount token (NOT user JWT — no user is present)
</span></code></pre></div>
<h4 id="453-webhook-events-to-handle">4.5.3 Webhook Events to Handle<a class="headerlink" href="#453-webhook-events-to-handle" title="Permanent link"> ¶</a></h4>
<p><strong>File:</strong> <code>ui/backend/controllers/billing/subscriptionController.js</code> (webhook handler)</p>
<blockquote>
<p><strong>Note:</strong> The webhook endpoint already exists at <code>POST /api/billing/webhook</code> (line ~963 in <code>subscriptionController.js</code>). It currently handles <code>customer.subscription.updated</code>, <code>customer.subscription.deleted</code>, and <code>invoice.payment_failed</code>. The raw body is preserved for Stripe signature verification (JSON parsing is skipped for this route in <code>app.js</code>).</p>
<p><strong>CRITICAL:</strong> <code>checkout.session.completed</code> is currently <strong>not</strong> handled in the webhook — subscription activation relies solely on the frontend calling <code>POST /api/billing/verify-checkout</code> after Stripe redirect. This is the <strong>#1 cause of "I paid but didn't get my upgrade" support tickets</strong> — browsers crash, tabs close, mobile networks drop. Implementing <code>checkout.session.completed</code> in the webhook is a <strong>must-have for Phase 1</strong>, not a fallback. The webhook is the only reliable source of truth for payment completion. The frontend verify-checkout should become a secondary fast-path, not the primary activation mechanism.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Stripe Event</th>
<th>Backend Action</th>
<th>Annotation Change</th>
<th>Go Controller Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>checkout.session.completed</code></td>
<td>Activate subscription (<strong>must-have</strong>)</td>
<td><code>plan-id</code>, <code>subscription: active</code></td>
<td>Create HRQ + LimitRange</td>
</tr>
<tr>
<td><code>customer.subscription.updated</code></td>
<td>Sync status/trial (exists)</td>
<td><code>status</code>, <code>is-trial</code>, <code>trial-end-date</code></td>
<td>Update HRQ if plan changed</td>
</tr>
<tr>
<td><code>customer.subscription.deleted</code></td>
<td>Start grace period (exists)</td>
<td><code>subscription: suspended</code>, <code>suspended-at</code> timestamp</td>
<td>Set HRQ to minimal suspended quota</td>
</tr>
<tr>
<td><code>invoice.payment_failed</code></td>
<td>Log warning (exists)</td>
<td><code>subscription: past_due</code> (optional)</td>
<td>Keep HRQ (grace period)</td>
</tr>
<tr>
<td><code>customer.subscription.trial_will_end</code></td>
<td>Send notification (to add)</td>
<td>No annotation change</td>
<td>No HRQ change</td>
</tr>
</tbody>
</table>
<p><strong>On cancellation, the HRQ should NOT be deleted immediately (see §7.2 for full lifecycle).</strong> Instead:
1. Mark subscription as <code>canceling</code> (existing behavior — keeps <code>plan-id</code>, full HRQ)
2. HRQ stays active for the remaining paid period
3. At period end (<code>customer.subscription.deleted</code>), set <code>suspended</code> → minimal HRQ (7-day grace)
4. After grace period, transition to <code>canceled</code> → workloads scaled to 0, data preserved</p>
<h4 id="454-add-on-flow-turbo-x1x2">4.5.4 Add-on Flow (Turbo x1/x2)<a class="headerlink" href="#454-add-on-flow-turbo-x1x2" title="Permanent link"> ¶</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>1. User clicks &quot;Add Turbo x1&quot; in UI
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>2. Frontend POST /api/billing/organization-subscription/addons { addonId: &quot;turbo-x1&quot; }
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>3. Backend verifies JWT → isOrgAdmin(token)
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>4. Backend adds item to Stripe subscription
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>5. Backend PATCHes Organization annotations:
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>     billing.kube-dc.com/addons: &#39;[{&quot;addonId&quot;:&quot;turbo-x1&quot;,&quot;quantity&quot;:1,...}]&#39;
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>6. Go controller sees addons changed → reconciles:
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>     → Reads base plan + addons from annotations
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>     → Recalculates total resources (plan.cpu + addon.cpu * quantity)
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>     → Updates HRQ spec.hard with new totals
</span></code></pre></div>
<h4 id="455-permission-model-rbac">4.5.5 Permission Model (RBAC)<a class="headerlink" href="#455-permission-model-rbac" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th>Actor</th>
<th>Identity</th>
<th>Can Read Organization</th>
<th>Can Patch Annotations</th>
<th>Can Manage HRQ</th>
<th>Can Manage LimitRange</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>User (org-admin)</strong></td>
<td>JWT from Dex/OIDC</td>
<td>✅</td>
<td>❌ (via backend only)</td>
<td>❌</td>
<td>❌ (in project ns; can create in org ns)</td>
</tr>
<tr>
<td><strong>User (member)</strong></td>
<td>JWT from Dex/OIDC</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td><strong>UI Backend</strong></td>
<td><code>kube-dc-backend</code> SA</td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td><strong>Go Controller</strong></td>
<td><code>kube-dc-manager</code> SA</td>
<td>✅</td>
<td>✅ (status only)</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>Stripe Webhook</strong></td>
<td>Webhook signature</td>
<td>N/A (uses Backend SA)</td>
<td>✅ (via Backend)</td>
<td>❌</td>
<td>❌</td>
</tr>
</tbody>
</table>
<p><strong>Key RBAC rules to add for HRQ integration:</strong></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># kube-dc-manager ServiceAccount — needs HRQ + LimitRange management</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hnc.x-k8s.io&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hierarchicalresourcequotas&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hnc.x-k8s.io&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hierarchyconfigurations&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;limitranges&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="c1"># kube-dc-backend ServiceAccount — reads HRQ status for usage display</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hnc.x-k8s.io&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hierarchicalresourcequotas&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div>
<p><strong>User RBAC (org-admin) — explicitly DENY HRQ writes:</strong></p>
<p>Users in org-admin group get a Role/RoleBinding in the org namespace that allows managing Projects, VMs, etc. but the Role must <strong>NOT</strong> include <code>hierarchicalresourcequotas</code> write permissions. HRQ is managed exclusively by the Go controller.</p>
<p>For LimitRange: org-admin <strong>can</strong> create/update LimitRange in the org namespace (this is the "user override" path from section 3.4.5). They cannot modify HNC-propagated copies in project namespaces (HNC webhook blocks this).</p>
<hr />
<h2 id="5-migration-strategy">5. Migration Strategy<a class="headerlink" href="#5-migration-strategy" title="Permanent link"> ¶</a></h2>
<h3 id="51-existing-organizations">5.1 Existing Organizations<a class="headerlink" href="#51-existing-organizations" title="Permanent link"> ¶</a></h3>
<p>For organizations that already have projects:</p>
<ol>
<li><strong>Install HNC</strong> — HNC controller starts watching namespaces</li>
<li><strong>Set hierarchy</strong> — Run migration script or controller reconciliation sets parent on all existing project namespaces</li>
<li><strong>Create HRQ</strong> — Organization controller creates HRQ based on existing billing annotations</li>
<li><strong>Verify</strong> — Check that <code>kubectl hns tree &lt;org-namespace&gt;</code> shows correct hierarchy</li>
</ol>
<p><strong>Migration script:</strong>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="c1"># For each organization namespace</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="k">for</span><span class="w"> </span>org<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>organizations<span class="w"> </span>-A<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].metadata.namespace}&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="c1"># For each project in the organization</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span>proj_ns<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>namespaces<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;kube-dc.com/project&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].metadata.name}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^</span><span class="si">${</span><span class="nv">org</span><span class="si">}</span><span class="s2">-&quot;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Setting parent of </span><span class="si">${</span><span class="nv">proj_ns</span><span class="si">}</span><span class="s2"> to </span><span class="si">${</span><span class="nv">org</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">        </span>kubectl<span class="w"> </span>hns<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="si">${</span><span class="nv">proj_ns</span><span class="si">}</span><span class="w"> </span>--parent<span class="w"> </span><span class="si">${</span><span class="nv">org</span><span class="si">}</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="k">done</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="k">done</span>
</span></code></pre></div></p>
<h3 id="52-new-organizations">5.2 New Organizations<a class="headerlink" href="#52-new-organizations" title="Permanent link"> ¶</a></h3>
<p>New organizations get the hierarchy configured automatically:
1. Organization controller creates org namespace (existing)
2. Project controller creates project namespace (existing)
3. <strong>NEW:</strong> Project controller sets HNC parent on project namespace
4. <strong>NEW:</strong> Organization controller creates HRQ + LimitRange when billing plan is activated
5. <strong>NEW:</strong> HNC propagates LimitRange from org namespace → all project namespaces</p>
<hr />
<h2 id="6-resource-mapping-details">6. Resource Mapping Details<a class="headerlink" href="#6-resource-mapping-details" title="Permanent link"> ¶</a></h2>
<h3 id="61-hrq-resource-types">6.1 HRQ Resource Types<a class="headerlink" href="#61-hrq-resource-types" title="Permanent link"> ¶</a></h3>
<table>
<thead>
<tr>
<th>HRQ Resource</th>
<th>Plan Field</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>requests.cpu</code></td>
<td><code>resources.cpu</code></td>
<td>Direct mapping (vCPU = Kubernetes CPU)</td>
</tr>
<tr>
<td><code>requests.memory</code></td>
<td><code>resources.memory</code></td>
<td>In GiB → <code>{N}Gi</code></td>
</tr>
<tr>
<td><code>limits.cpu</code></td>
<td><code>resources.cpu * burst</code></td>
<td>Burst ratio: 3x (dev), 2x (pro), 1.5x (scale)</td>
</tr>
<tr>
<td><code>limits.memory</code></td>
<td><code>resources.memory * burst</code></td>
<td>Same per-plan burst ratio</td>
</tr>
<tr>
<td><code>requests.storage</code></td>
<td><code>resources.storage</code></td>
<td>PVC storage in GiB</td>
</tr>
<tr>
<td><code>pods</code></td>
<td>Computed</td>
<td>100 for dev, 200 for pro, 500 for scale</td>
</tr>
<tr>
<td><code>services.loadbalancers</code></td>
<td>Computed</td>
<td>3 for dev, 5 for pro, 10 for scale (LB count, not IPv4)</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Note:</strong> Public IPv4 (EIP) quota is enforced separately via the EIP controller — not via HRQ. See §6.4.</p>
</blockquote>
<h3 id="62-object-storage-rook-ceph-s3-quotas">6.2 Object Storage (Rook-Ceph S3 Quotas)<a class="headerlink" href="#62-object-storage-rook-ceph-s3-quotas" title="Permanent link"> ¶</a></h3>
<p>Object storage (<code>resources.objectStorage</code>) is <strong>not enforceable via Kubernetes ResourceQuota/HRQ</strong>. However, Rook-Ceph provides <strong>native CRD-based quota enforcement</strong> via <code>CephObjectStoreUser</code>, which fits the same controller-driven pattern as HRQ.</p>
<h4 id="621-how-it-works">6.2.1 How It Works<a class="headerlink" href="#621-how-it-works" title="Permanent link"> ¶</a></h4>
<p>Rook-Ceph's <code>CephObjectStoreUser</code> CRD has built-in <code>spec.quotas</code>:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph.rook.io/v1</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CephObjectStoreUser</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-corp</span><span class="w">                      </span><span class="c1"># one per organization</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class="w">                 </span><span class="c1"># Rook-Ceph operator namespace</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">  </span><span class="nt">store</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-store</span><span class="w">                      </span><span class="c1"># CephObjectStore name</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;acme-corp&quot;</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">  </span><span class="nt">quotas</span><span class="p">:</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="w">    </span><span class="nt">maxBuckets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">                     </span><span class="c1"># max number of buckets</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20G</span><span class="w">                       </span><span class="c1"># total size across all buckets (plan: objectStorage)</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="w">    </span><span class="nt">maxObjects</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100000</span><span class="w">                 </span><span class="c1"># max object count (optional safeguard)</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="w">  </span><span class="nt">capabilities</span><span class="p">:</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;read&quot;</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="w">    </span><span class="nt">bucket</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
</span></code></pre></div>
<p>Ceph RGW (RADOS Gateway) enforces these quotas server-side — S3 PUT requests that exceed the quota are rejected with <code>403 QuotaExceeded</code>.</p>
<h4 id="622-integration-pattern-same-as-hrq">6.2.2 Integration Pattern (Same as HRQ)<a class="headerlink" href="#622-integration-pattern-same-as-hrq" title="Permanent link"> ¶</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>Plan activated → controller creates/updates CephObjectStoreUser with plan quotas
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>Plan changed  → controller updates maxSize to new plan&#39;s objectStorage value
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>Plan canceled → controller sets maxSize to 0 (or deletes user)
</span></code></pre></div>
<p><strong>Controller logic in <code>organization.Sync()</code></strong> (alongside HRQ + LimitRange):</p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1">// Sync Ceph S3 user quota alongside HRQ</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nx">log</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;Sync object storage quota...&quot;</span><span class="p">)</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">if</span><span class="w"> </span><span class="nx">planResources</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="nx">s3Quota</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewOrganizationS3Quota</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">planResources</span><span class="p">.</span><span class="nx">ObjectStorage</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s3Quota</span><span class="p">.</span><span class="nx">Sync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Plan-to-S3 quota mapping:</strong></p>
<table>
<thead>
<tr>
<th>Plan</th>
<th><code>maxSize</code></th>
<th><code>maxBuckets</code></th>
<th><code>maxObjects</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>Dev Pool</td>
<td>20Gi</td>
<td>5</td>
<td>100,000</td>
</tr>
<tr>
<td>Pro Pool</td>
<td>100Gi</td>
<td>20</td>
<td>1,000,000</td>
</tr>
<tr>
<td>Scale Pool</td>
<td>500Gi</td>
<td>50</td>
<td>10,000,000</td>
</tr>
</tbody>
</table>
<h4 id="623-per-bucket-quotas-via-objectbucketclaim">6.2.3 Per-Bucket Quotas via ObjectBucketClaim<a class="headerlink" href="#623-per-bucket-quotas-via-objectbucketclaim" title="Permanent link"> ¶</a></h4>
<p>Users create buckets via <code>ObjectBucketClaim</code> (OBC), which also supports per-bucket quotas:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">objectbucket.io/v1alpha1</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ObjectBucketClaim</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-bucket</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-corp-dev</span><span class="w">             </span><span class="c1"># project namespace</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">  </span><span class="nt">generateBucketName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-corp-dev-</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph-bucket</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">  </span><span class="nt">additionalConfig</span><span class="p">:</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5G&quot;</span><span class="w">                      </span><span class="c1"># per-bucket limit (optional, user-configurable)</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">    </span><span class="nt">maxObjects</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50000&quot;</span>
</span></code></pre></div>
<p>The user-level quota (<code>CephObjectStoreUser.spec.quotas.maxSize</code>) enforces the <strong>org-wide total</strong> regardless of per-bucket settings — same relationship as HRQ (org total) vs ResourceQuota (per-project).</p>
<h4 id="624-rbac-credential-management">6.2.4 RBAC &amp; Credential Management<a class="headerlink" href="#624-rbac-credential-management" title="Permanent link"> ¶</a></h4>
<ul>
<li><strong><code>kube-dc-manager</code> SA</strong> creates/updates <code>CephObjectStoreUser</code> in the <code>rook-ceph</code> namespace (needs RBAC for <code>cephobjectstoreusers</code> CRD)</li>
<li>Rook operator auto-creates a <strong>Secret</strong> with S3 credentials (AccessKey, SecretKey) named <code>rook-ceph-object-user-{store}-{user}</code></li>
<li>Controller copies/references the credentials Secret to the org namespace so projects can access S3</li>
<li>Users create <code>ObjectBucketClaim</code> in project namespaces (standard RBAC, already works with Rook)</li>
</ul>
<h4 id="625-subscription-lifecycle">6.2.5 Subscription Lifecycle<a class="headerlink" href="#625-subscription-lifecycle" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th>Status</th>
<th>S3 Quota Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>active</code></td>
<td><code>maxSize</code> = plan's <code>objectStorage</code> value</td>
</tr>
<tr>
<td><code>suspended</code></td>
<td><code>maxSize</code> = <code>0</code> (block new uploads, existing data preserved)</td>
</tr>
<tr>
<td><code>canceled</code></td>
<td><code>maxSize</code> = <code>0</code>, data preserved during retention period</td>
</tr>
<tr>
<td>Re-subscribe</td>
<td><code>maxSize</code> restored to new plan value</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Confirmed feasible:</strong> Rook-Ceph <code>CephObjectStoreUser</code> quotas are enforced server-side by Ceph RGW. The same annotation-driven controller pattern (Stripe → annotations → Go controller → CRD update) works for S3 quotas. Implementation can be done alongside or after HRQ integration.</p>
</blockquote>
<h3 id="63-kubevirt-vm-resources">6.3 KubeVirt VM Resources<a class="headerlink" href="#63-kubevirt-vm-resources" title="Permanent link"> ¶</a></h3>
<p>VMs created via KubeVirt consume CPU/memory from the same quota as pods. The <code>requests.cpu</code> and <code>requests.memory</code> in the HRQ naturally cover both containers and VMs, since KubeVirt VMs run as pods with <code>resources.requests</code> set.</p>
<p><strong>Important:</strong> Ensure VMs have proper <code>resources.requests</code> set, or they won't be counted against the quota. The Kube-DC VM templates should enforce this.</p>
<h3 id="64-public-ipv4-eip-quota-enforcement">6.4 Public IPv4 (EIP) Quota Enforcement<a class="headerlink" href="#64-public-ipv4-eip-quota-enforcement" title="Permanent link"> ¶</a></h3>
<p>Public IPv4 addresses are allocated via Kube-DC's <code>EIp</code> CRD. EIPs with <code>spec.externalNetworkType: public</code> (label <code>network.kube-dc.com/external-network-type: public</code>) consume real public IPs from the <code>ext-public</code> subnet. These are a scarce, paid resource and must be quota-controlled per organization.</p>
<h4 id="641-why-hrq-cant-track-eips">6.4.1 Why HRQ Can’t Track EIPs<a class="headerlink" href="#641-why-hrq-cant-track-eips" title="Permanent link"> ¶</a></h4>
<p>HRQ/ResourceQuota only tracks standard Kubernetes resources (<code>pods</code>, <code>services.loadbalancers</code>, <code>requests.cpu</code>, etc.). <code>EIp</code> is a Kube-DC custom CRD — Kubernetes quota admission doesn't know about it. We need <strong>controller-side enforcement</strong>.</p>
<h4 id="642-design-eip-controller-quota-check">6.4.2 Design: EIP Controller Quota Check<a class="headerlink" href="#642-design-eip-controller-quota-check" title="Permanent link"> ¶</a></h4>
<p>Before creating a new public EIP, the EIP controller counts existing public EIPs across all project namespaces for the organization and compares against the plan's <code>ipv4</code> limit.</p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1">// In EIP controller Reconcile(), before creating OvnEip:</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">checkPublicEIPQuota</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cli</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">projectNamespace</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="c1">// 1. Get organization name from project namespace</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="nx">orgName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getOrgFromProjectNamespace</span><span class="p">(</span><span class="nx">projectNamespace</span><span class="p">)</span><span class="w"> </span><span class="c1">// e.g., &quot;shalb&quot; from &quot;shalb-demo&quot;</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="c1">// 2. Get organization&#39;s plan ipv4 limit from annotations</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="nx">org</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">Organization</span><span class="p">{}</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="nx">cli</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">orgName</span><span class="p">,</span><span class="w"> </span><span class="nx">Namespace</span><span class="p">:</span><span class="w"> </span><span class="nx">orgName</span><span class="p">},</span><span class="w"> </span><span class="nx">org</span><span class="p">)</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="nx">planId</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">org</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/plan-id&quot;</span><span class="p">]</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">    </span><span class="nx">plan</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GetPlanResources</span><span class="p">(</span><span class="nx">planId</span><span class="p">)</span><span class="w">  </span><span class="c1">// plan.IPv4 = 1 (dev), 1 (pro), 3 (scale)</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">    </span><span class="c1">// 3. Count public EIPs across ALL project namespaces for this org</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">    </span><span class="nx">eipList</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">kubedccomv1</span><span class="p">.</span><span class="nx">EIpList</span><span class="p">{}</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">    </span><span class="nx">cli</span><span class="p">.</span><span class="nx">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">eipList</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">MatchingLabels</span><span class="p">{</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="w">        </span><span class="s">&quot;network.kube-dc.com/external-network-type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public&quot;</span><span class="p">,</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="w">    </span><span class="c1">// Filter to only EIPs in namespaces belonging to this org</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="w">    </span><span class="nx">count</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">eip</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eipList</span><span class="p">.</span><span class="nx">Items</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">eip</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">orgName</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">eip</span><span class="p">.</span><span class="nx">Namespace</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">orgName</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="w">            </span><span class="nx">count</span><span class="o">++</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="w">    </span><span class="c1">// 4. Reject if over quota</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">IPv4</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;public EIP quota exceeded: %d/%d for organization %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">IPv4</span><span class="p">,</span><span class="w"> </span><span class="nx">orgName</span><span class="p">)</span>
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Race condition mitigation:</strong> If multiple EIPs are created simultaneously (e.g., <code>kubectl apply -f 5-eips.yaml</code>), parallel reconcile threads could each see <code>count=0</code> and all pass the check. Mitigation: the EIP controller uses a <strong>single worker queue per organization</strong> (controller-runtime's default concurrency is 1 per controller). If higher concurrency is configured, add a post-creation recount — after creating the OvnEip, re-list public EIPs and if <code>count &gt; limit</code>, delete the just-created EIP and return an error (compensating transaction). In practice, EIP creation is rare and slow (OVN provisioning), so the default single-worker queue is sufficient for MVP.</p>
<h4 id="643-plan-to-eip-quota-mapping">6.4.3 Plan-to-EIP Quota Mapping<a class="headerlink" href="#643-plan-to-eip-quota-mapping" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th>Plan</th>
<th><code>resources.ipv4</code></th>
<th>Max Public EIPs</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dev Pool</td>
<td>1</td>
<td>1</td>
<td>1 public IP (default-gw SNAT + shared LB)</td>
</tr>
<tr>
<td>Pro Pool</td>
<td>1</td>
<td>1</td>
<td>1 public IP</td>
</tr>
<tr>
<td>Scale Pool</td>
<td>3</td>
<td>3</td>
<td>3 public IPs (dedicated LBs, multiple services)</td>
</tr>
</tbody>
</table>
<h4 id="644-what-counts-as-a-public-eip">6.4.4 What Counts as a Public EIP<a class="headerlink" href="#644-what-counts-as-a-public-eip" title="Permanent link"> ¶</a></h4>
<p>Only EIPs with <strong><code>spec.externalNetworkType: public</code></strong> count against the quota. EIPs with <code>externalNetworkType: cloud</code> use internal cloud IPs from <code>ext-cloud</code> subnet and are <strong>not</strong> quota-controlled (they're free internal addresses).</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>EIP label: network.kube-dc.com/external-network-type: public  → COUNTS against ipv4 quota
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>EIP label: network.kube-dc.com/external-network-type: cloud   → does NOT count
</span></code></pre></div>
<h4 id="645-enforcement-points">6.4.5 Enforcement Points<a class="headerlink" href="#645-enforcement-points" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th>Action</th>
<th>Enforcement</th>
</tr>
</thead>
<tbody>
<tr>
<td>Project creation (auto-creates <code>default-gw</code> EIP)</td>
<td>EIP controller checks quota before creating public EIP</td>
</tr>
<tr>
<td>User creates additional EIP via kubectl/UI</td>
<td>EIP controller checks quota</td>
</tr>
<tr>
<td>Service type=LoadBalancer (may allocate EIP)</td>
<td>Service controller / EIP controller checks quota</td>
</tr>
<tr>
<td>Plan downgrade (e.g., 3 → 1 IPv4)</td>
<td>Existing EIPs <strong>not deleted</strong> — but new ones blocked until under limit</td>
</tr>
</tbody>
</table>
<h4 id="646-subscription-lifecycle">6.4.6 Subscription Lifecycle<a class="headerlink" href="#646-subscription-lifecycle" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th>Status</th>
<th>EIP Quota Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>active</code></td>
<td>Enforce plan's <code>ipv4</code> limit</td>
</tr>
<tr>
<td><code>suspended</code></td>
<td>Block new public EIPs (limit = 0), keep existing</td>
</tr>
<tr>
<td><code>canceled</code></td>
<td>Block new public EIPs, existing released when workloads scaled down</td>
</tr>
<tr>
<td>No plan</td>
<td>No quota enforcement (or limit = 0 if billing is mandatory)</td>
</tr>
</tbody>
</table>
<h4 id="647-usage-reporting">6.4.7 Usage Reporting<a class="headerlink" href="#647-usage-reporting" title="Permanent link"> ¶</a></h4>
<p>The backend should expose public EIP count alongside HRQ usage:</p>
<div class="language-javascript highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1">// In getOrganizationQuotaUsage():</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">eipUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://</span><span class="si">${</span><span class="nb">global</span><span class="p">.</span><span class="nx">k8sUrl</span><span class="si">}</span><span class="sb">/apis/kube-dc.com/v1/eips?labelSelector=network.kube-dc.com/external-network-type=public`</span><span class="p">;</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="c1">// Filter by org namespaces, count results</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="k">return</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">    </span><span class="c1">// ... existing HRQ usage</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">    </span><span class="nx">ipv4</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">        </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nx">publicEipCount</span><span class="p">,</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">        </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="nx">plan</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">ipv4</span><span class="p">,</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="65-kube-dc-system-resources">6.5 Kube-DC System Resources<a class="headerlink" href="#65-kube-dc-system-resources" title="Permanent link"> ¶</a></h3>
<p>Resources consumed by Kube-DC infrastructure in project namespaces count against the quota. The overhead must be <strong>explicitly accounted for</strong> in <code>plan_resources.go</code> so users get the full advertised resources.</p>
<p><strong>System pod footprint per project namespace:</strong></p>
<table>
<thead>
<tr>
<th>System Pod</th>
<th>CPU Request</th>
<th>Memory Request</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>VpcDns (CoreDNS)</td>
<td>100m</td>
<td>128Mi</td>
<td>Created by Kube-OVN per project</td>
</tr>
</tbody>
</table>
<p><strong>Per-project overhead:</strong> ~100m CPU, ~128Mi memory.</p>
<p><strong>Recommended implementation in <code>plan_resources.go</code>:</strong> Add a fixed overhead per project to the HRQ, based on <code>OrganizationProjectsLimit</code> (default: 3):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>overhead_cpu    = projects_limit * 100m   → 300m for 3 projects
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>overhead_memory = projects_limit * 128Mi  → 384Mi for 3 projects
</span></code></pre></div>
<p>So if the plan advertises 4 CPU, the HRQ <code>requests.cpu</code> should be <code>4.3</code> (= 4 + 0.3 overhead). This prevents the scenario where a user sees "4 CPU" in the UI but can only schedule 3.7 CPU of their own workloads. The UI should display the <strong>user-available</strong> amount (plan value), not the raw HRQ value.</p>
<hr />
<h2 id="7-edge-cases-considerations">7. Edge Cases &amp; Considerations<a class="headerlink" href="#7-edge-cases-considerations" title="Permanent link"> ¶</a></h2>
<h3 id="71-quota-exceeded-on-plan-downgrade">7.1 Quota Exceeded on Plan Downgrade<a class="headerlink" href="#71-quota-exceeded-on-plan-downgrade" title="Permanent link"> ¶</a></h3>
<p>If a user downgrades from Scale Pool (16 CPU) to Dev Pool (4 CPU) but is using 10 CPU:
- <strong>HRQ updates immediately</strong> — new limit is 4 CPU
- <strong>Existing pods are NOT evicted</strong> — Kubernetes quotas only block new pod creation
- <strong>New pods will fail</strong> until usage drops below the new limit
- <strong>UI must warn</strong> before downgrade if current usage exceeds new plan</p>
<h3 id="72-subscription-expiration-post-cancellation-lifecycle">7.2 Subscription Expiration &amp; Post-Cancellation Lifecycle<a class="headerlink" href="#72-subscription-expiration-post-cancellation-lifecycle" title="Permanent link"> ¶</a></h3>
<p>When a subscription ends (trial expires, cancellation at period end, or payment failure), we need a <strong>phased wind-down</strong> — not an instant shutdown. The goal: give users time to re-subscribe or export data, while preventing free-riding.</p>
<p><strong>Key Kubernetes constraint:</strong> HRQ only blocks <strong>new</strong> pod creation. Setting HRQ to 0 does NOT evict running pods — they keep running until they crash/restart, at which point they can't come back.</p>
<h4 id="phase-1-warning-before-expiration">Phase 1: Warning (before expiration)<a class="headerlink" href="#phase-1-warning-before-expiration" title="Permanent link"> ¶</a></h4>
<p>No HRQ changes. Notifications only.</p>
<table>
<thead>
<tr>
<th>Trigger</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>7 days before period end</td>
<td>Email + in-app notification: "Your subscription expires in 7 days"</td>
</tr>
<tr>
<td>3 days before</td>
<td>Email + persistent UI banner</td>
</tr>
<tr>
<td>1 day before</td>
<td>Email + UI banner: "Last chance to renew"</td>
</tr>
<tr>
<td>Trial: <code>customer.subscription.trial_will_end</code></td>
<td>Stripe fires this 3 days before trial ends</td>
</tr>
</tbody>
</table>
<h4 id="phase-2-grace-period-7-days-after-expiration">Phase 2: Grace Period (7 days after expiration)<a class="headerlink" href="#phase-2-grace-period-7-days-after-expiration" title="Permanent link"> ¶</a></h4>
<p><strong>Annotation:</strong> <code>billing.kube-dc.com/subscription: suspended</code></p>
<p>The Go controller sets HRQ to a <strong>minimal "suspended" quota</strong> instead of deleting it:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1"># Suspended quota — enough for system pods only</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hnc.x-k8s.io/v1alpha2</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HierarchicalResourceQuota</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plan-quota</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-corp</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="nt">billing.kube-dc.com/auto-managed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="nt">billing.kube-dc.com/plan-id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;suspended&quot;</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">  </span><span class="nt">hard</span><span class="p">:</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="nt">requests.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500m&quot;</span><span class="w">          </span><span class="c1"># ~150m per project for VpcDns + buffer</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1Gi&quot;</span><span class="w">        </span><span class="c1"># ~256Mi per project for VpcDns + buffer</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="nt">limits.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">    </span><span class="nt">limits.memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2Gi&quot;</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="nt">requests.storage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w">         </span><span class="c1"># block new PVCs</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span><span class="w">                    </span><span class="c1"># only system pods</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="nt">services.loadbalancers</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="w">   </span><span class="c1"># block new LBs</span>
</span></code></pre></div>
<p><strong>What happens to running workloads:</strong>
- Existing pods <strong>keep running</strong> (Kubernetes doesn't evict on quota change)
- If a pod crashes/restarts and there's quota headroom → it comes back
- If quota is exhausted → crashed pods can't restart, user workloads degrade naturally
- System pods (VpcDns) have priority because they're small (~50m CPU, ~64Mi memory each)
- New user workloads blocked (quota too small for anything meaningful)
- New PVCs and LoadBalancers blocked</p>
<p><strong>User experience:</strong>
- Console shows "Subscription expired — renew to restore full access" banner
- Billing page shows "Suspended" status with one-click re-subscribe
- Users can still view resources, check logs, export data
- Users <strong>cannot</strong> create new VMs, deployments, or PVCs</p>
<p><strong>Controller logic in <code>organization.Sync()</code>:</strong></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nx">subscriptionStatus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">org</span><span class="p">.</span><span class="nx">GetAnnotations</span><span class="p">()[</span><span class="s">&quot;billing.kube-dc.com/subscription&quot;</span><span class="p">]</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="k">switch</span><span class="w"> </span><span class="nx">subscriptionStatus</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="k">case</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;trialing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;canceling&quot;</span><span class="p">:</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="c1">// Active plan — full HRQ from plan resources</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="nx">planResources</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GetPlanResourcesFromAnnotations</span><span class="p">(</span><span class="nx">org</span><span class="p">)</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">    </span><span class="c1">// ... create/update HRQ with full limits</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="k">case</span><span class="w"> </span><span class="s">&quot;suspended&quot;</span><span class="p">:</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">    </span><span class="c1">// Grace period — minimal quota for system pods only</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="nx">hrqRes</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewSuspendedHRQ</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">    </span><span class="c1">// ... create/update HRQ with suspended limits</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="k">case</span><span class="w"> </span><span class="s">&quot;canceled&quot;</span><span class="p">:</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">    </span><span class="c1">// Past grace period — scale down + minimal quota</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="w">    </span><span class="nx">hrqRes</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewSuspendedHRQ</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">log</span><span class="p">)</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">    </span><span class="c1">// ... also trigger workload suspension (Phase 3)</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="k">default</span><span class="p">:</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="w">    </span><span class="c1">// No subscription — no HRQ (no quota enforcement)</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="phase-3-workload-suspension-after-grace-period-day-8">Phase 3: Workload Suspension (after grace period, day 8+)<a class="headerlink" href="#phase-3-workload-suspension-after-grace-period-day-8" title="Permanent link"> ¶</a></h4>
<p><strong>Annotation:</strong> <code>billing.kube-dc.com/subscription: canceled</code></p>
<p>The Stripe webhook fires <code>customer.subscription.deleted</code> → backend sets status to <code>canceled</code>. If the user hasn't re-subscribed within the grace period, the controller <strong>actively suspends workloads</strong>:</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Action</th>
<th>Reversible?</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deployments</td>
<td>Scale replicas to 0, save original in annotation</td>
<td>✅ Restore on re-subscribe</td>
</tr>
<tr>
<td>StatefulSets</td>
<td>Scale replicas to 0, save original in annotation</td>
<td>✅ Restore on re-subscribe</td>
</tr>
<tr>
<td>VirtualMachines</td>
<td>Set <code>runStrategy: Halted</code></td>
<td>✅ Set back to <code>Always</code> on re-subscribe</td>
</tr>
<tr>
<td>CronJobs</td>
<td>Set <code>suspend: true</code></td>
<td>✅ Set back to <code>false</code> on re-subscribe</td>
</tr>
<tr>
<td>PVCs</td>
<td><strong>Keep</strong> (data preserved)</td>
<td>✅ Data intact</td>
</tr>
<tr>
<td>Secrets, ConfigMaps</td>
<td><strong>Keep</strong></td>
<td>✅ Intact</td>
</tr>
<tr>
<td>Services, Ingress</td>
<td><strong>Keep</strong> (but no backends)</td>
<td>✅ Intact</td>
</tr>
</tbody>
</table>
<p><strong>Implementation:</strong> New function <code>SuspendOrgWorkloads(ctx, cli, orgNamespace)</code> that:
1. Lists all project namespaces for the org
2. For each project namespace, scales down all Deployments/StatefulSets, halts VMs
3. Stores original replica counts in annotations (e.g., <code>billing.kube-dc.com/pre-suspend-replicas: "3"</code>)
4. On re-subscribe, <code>RestoreOrgWorkloads()</code> reads annotations and restores everything</p>
<p><strong>HRQ stays at "suspended" quota</strong> — system pods (VpcDns) keep running for network integrity.</p>
<h4 id="phase-4-data-retention-day-30-configurable">Phase 4: Data Retention (day 30+, configurable)<a class="headerlink" href="#phase-4-data-retention-day-30-configurable" title="Permanent link"> ¶</a></h4>
<p>After 30 days of <code>canceled</code> status with no re-subscription:
- Send final "Data deletion warning" email
- After 60 days: mark org for cleanup
- After 90 days: delete project namespaces and all data (PVCs, secrets, etc.)</p>
<blockquote>
<p><strong>Design decision:</strong> Data retention period should be configurable per deployment. Cloud providers typically use 30-90 days. Self-hosted Kube-DC may have different policies.</p>
</blockquote>
<h4 id="summary-subscription-status-hrq-state">Summary: Subscription Status → HRQ State<a class="headerlink" href="#summary-subscription-status-hrq-state" title="Permanent link"> ¶</a></h4>
<table>
<thead>
<tr>
<th><code>subscription</code> annotation</th>
<th>HRQ State</th>
<th>Workloads</th>
<th>User Can...</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>active</code> / <code>trialing</code></td>
<td>Full plan quota</td>
<td>Running normally</td>
<td>Create, scale, everything</td>
</tr>
<tr>
<td><code>canceling</code></td>
<td>Full plan quota (paid period)</td>
<td>Running normally</td>
<td>Everything (until period end)</td>
</tr>
<tr>
<td><code>suspended</code> (grace, 7d)</td>
<td>Minimal quota (0.5 CPU, 1Gi)</td>
<td>Running but can't scale/restart</td>
<td>View, export, re-subscribe</td>
</tr>
<tr>
<td><code>canceled</code> (post-grace)</td>
<td>Minimal quota</td>
<td>Scaled to 0 by controller</td>
<td>View data, re-subscribe</td>
</tr>
<tr>
<td><code>""</code> (no plan ever)</td>
<td>No HRQ (no enforcement)</td>
<td>Running freely</td>
<td>Everything (no billing)</td>
</tr>
</tbody>
</table>
<h4 id="stripe-annotation-state-machine">Stripe → Annotation State Machine<a class="headerlink" href="#stripe-annotation-state-machine" title="Permanent link"> ¶</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>checkout.session.completed    → &quot;active&quot;
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>subscription.updated (active) → &quot;active&quot;
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>subscription.updated (trial)  → &quot;trialing&quot;
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>user cancels (period end)     → &quot;canceling&quot;
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>period ends / trial expires   → &quot;suspended&quot;  ← 7-day grace starts
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>grace period ends (cron/timer)→ &quot;canceled&quot;   ← workloads suspended
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>user re-subscribes at any point → &quot;active&quot;   ← full restore
</span></code></pre></div>
<blockquote>
<p><strong>Note on <code>suspended</code> vs <code>canceled</code> transition:</strong> Stripe fires <code>customer.subscription.deleted</code> at period end. The backend should set <code>suspended</code> (not <code>canceled</code>) and record <code>billing.kube-dc.com/suspended-at</code> timestamp. A separate cron job or controller timer checks if 7 days have passed since <code>suspended-at</code> and transitions to <code>canceled</code> + triggers workload suspension.</p>
</blockquote>
<h3 id="73-hnc-controller-unavailability">7.3 HNC Controller Unavailability<a class="headerlink" href="#73-hnc-controller-unavailability" title="Permanent link"> ¶</a></h3>
<p>If HNC controller is down:
- HRQ enforcement stops (no admission webhook)
- Existing pods continue running
- New pods may be created without quota checks
- <strong>Mitigation:</strong> HNC should be a critical system component with proper HA</p>
<h3 id="74-race-conditions">7.4 Race Conditions<a class="headerlink" href="#74-race-conditions" title="Permanent link"> ¶</a></h3>
<ul>
<li>Plan change + simultaneous pod creation: HNC admission webhook serializes checks</li>
<li>Multiple addon additions: Backend should serialize Organization annotation updates</li>
<li>Organization deletion with active HRQ: Project controller deletes hierarchy first, then org controller cleans up HRQ</li>
</ul>
<h3 id="75-hnc-and-kube-ovn-interaction">7.5 HNC and Kube-OVN Interaction<a class="headerlink" href="#75-hnc-and-kube-ovn-interaction" title="Permanent link"> ¶</a></h3>
<p>HNC propagates resources from parent to child namespaces. Ensure Kube-OVN CRDs are set to <code>Ignore</code> mode in HNC configuration to prevent unwanted propagation of VPCs, Subnets, etc.</p>
<hr />
<h2 id="8-api-changes">8. API Changes<a class="headerlink" href="#8-api-changes" title="Permanent link"> ¶</a></h2>
<h3 id="81-new-backend-endpoints">8.1 New Backend Endpoints<a class="headerlink" href="#81-new-backend-endpoints" title="Permanent link"> ¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>GET  /api/billing/quota-usage          → Real-time HRQ usage from K8s API
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>GET  /api/billing/quota-status         → HRQ existence and health check
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>POST /api/billing/simulate-downgrade   → Check if downgrade is safe (usage &lt; new limits)
</span></code></pre></div>
<h3 id="82-organization-crd-changes-optional">8.2 Organization CRD Changes (Optional)<a class="headerlink" href="#82-organization-crd-changes-optional" title="Permanent link"> ¶</a></h3>
<p>Consider adding quota status to Organization CRD status:</p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">OrganizationStatus</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="nx">Ready</span><span class="w">      </span><span class="kt">bool</span><span class="w">               </span><span class="s">`json:&quot;ready&quot;`</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="nx">Conditions</span><span class="w"> </span><span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="w"> </span><span class="s">`json:&quot;conditions,omitempty&quot;`</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="c1">// NEW: Quota status</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="nx">QuotaEnforced</span><span class="w"> </span><span class="kt">bool</span><span class="w">            </span><span class="s">`json:&quot;quotaEnforced,omitempty&quot;`</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="nx">QuotaPlanId</span><span class="w">   </span><span class="kt">string</span><span class="w">          </span><span class="s">`json:&quot;quotaPlanId,omitempty&quot;`</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="p">}</span>
</span></code></pre></div>
<hr />
<h2 id="9-testing-plan">9. Testing Plan<a class="headerlink" href="#9-testing-plan" title="Permanent link"> ¶</a></h2>
<h3 id="91-unit-tests">9.1 Unit Tests<a class="headerlink" href="#91-unit-tests" title="Permanent link"> ¶</a></h3>
<ul>
<li>Plan-to-HRQ resource mapping</li>
<li>Addon calculation logic</li>
<li>Annotation parsing for plan resources</li>
</ul>
<h3 id="92-e2e-tests">9.2 E2E Tests<a class="headerlink" href="#92-e2e-tests" title="Permanent link"> ¶</a></h3>
<p>Add to <code>tests/e2e/</code>:</p>
<ol>
<li><strong>HRQ Creation Test:</strong></li>
<li>Create organization with billing plan annotation</li>
<li>Verify HRQ is created with correct limits</li>
<li>
<p>Create project, verify namespace is child of org namespace</p>
</li>
<li>
<p><strong>Quota Enforcement Test:</strong></p>
</li>
<li>Create organization with Dev Pool plan (4 CPU)</li>
<li>Create pods consuming close to 4 CPU across projects</li>
<li>
<p>Verify next pod fails with quota exceeded error</p>
</li>
<li>
<p><strong>Plan Upgrade Test:</strong></p>
</li>
<li>Start with Dev Pool (4 CPU), upgrade to Pro Pool (8 CPU)</li>
<li>Verify HRQ limits are updated</li>
<li>
<p>Verify previously blocked pods can now be created</p>
</li>
<li>
<p><strong>Plan Cancellation Test:</strong></p>
</li>
<li>Cancel subscription</li>
<li>Verify HRQ is removed or set to minimal limits</li>
<li>Verify new pod creation is blocked</li>
</ol>
<h3 id="93-manual-testing">9.3 Manual Testing<a class="headerlink" href="#93-manual-testing" title="Permanent link"> ¶</a></h3>
<ul>
<li>Stripe test mode checkout → verify HRQ creation</li>
<li>Turbo addon purchase → verify HRQ update</li>
<li>UI quota usage display with real metrics</li>
</ul>
<hr />
<h2 id="10-deployment-sequence">10. Deployment Sequence<a class="headerlink" href="#10-deployment-sequence" title="Permanent link"> ¶</a></h2>
<h3 id="101-phase-rollout">10.1 Phase Rollout<a class="headerlink" href="#101-phase-rollout" title="Permanent link"> ¶</a></h3>
<ol>
<li><strong>Phase 1 (Week 1-2):</strong> Install HNC, configure hierarchy for existing namespaces, no enforcement</li>
<li><strong>Phase 2 (Week 3-4):</strong> Add Go controller changes, create HRQ on plan selection, migration script</li>
<li><strong>Phase 3 (Week 5):</strong> Update backend to read real HRQ usage, update UI</li>
<li><strong>Phase 4 (Week 6):</strong> End-to-end testing, Stripe webhook integration</li>
<li><strong>Phase 5 (Week 7):</strong> Production rollout with monitoring</li>
</ol>
<h3 id="102-rollback-plan">10.2 Rollback Plan<a class="headerlink" href="#102-rollback-plan" title="Permanent link"> ¶</a></h3>
<ul>
<li>HRQ can be deleted without affecting running workloads</li>
<li>LimitRange deletion does not affect running pods (only applies at admission time)</li>
<li>HNC hierarchy can be removed by unsetting parent annotations</li>
<li>Organization annotations remain unchanged (billing data safe)</li>
<li>Backend falls back to mock usage if HRQ not found</li>
</ul>
<hr />
<h2 id="11-files-to-createmodify">11. Files to Create/Modify<a class="headerlink" href="#11-files-to-createmodify" title="Permanent link"> ¶</a></h2>
<h3 id="new-files">New Files<a class="headerlink" href="#new-files" title="Permanent link"> ¶</a></h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>internal/project/res_hierarchy.go</code></td>
<td>HierarchyConfiguration resource for project namespace</td>
</tr>
<tr>
<td><code>internal/organization/res_hrq.go</code></td>
<td>HierarchicalResourceQuota resource management</td>
</tr>
<tr>
<td><code>internal/organization/res_limitrange.go</code></td>
<td>LimitRange auto-creation with plan defaults, user override detection (§3.4.5)</td>
</tr>
<tr>
<td><code>internal/organization/res_s3_quota.go</code></td>
<td>Rook-Ceph CephObjectStoreUser quota management (§6.2)</td>
</tr>
<tr>
<td><code>internal/organization/plan_resources.go</code></td>
<td>Plan-to-resource mapping, burst ratios, addon calculation (§3.6)</td>
</tr>
<tr>
<td><code>internal/organization/workload_suspend.go</code></td>
<td>SuspendOrgWorkloads / RestoreOrgWorkloads for post-cancellation lifecycle (§7.2)</td>
</tr>
<tr>
<td><code>charts/kube-dc/templates/hnc-install.yaml</code></td>
<td>HNC installation manifests</td>
</tr>
<tr>
<td><code>charts/kube-dc/templates/hnc-config.yaml</code></td>
<td>HNC configuration (propagation rules for LimitRange, RBAC, Secrets)</td>
</tr>
<tr>
<td><code>charts/kube-dc/templates/hnc-rbac.yaml</code></td>
<td>RBAC for kube-dc-manager to manage HNC + LimitRange + CephObjectStoreUser</td>
</tr>
<tr>
<td><code>tests/e2e/quota_test.go</code></td>
<td>E2E tests for quota enforcement</td>
</tr>
<tr>
<td><code>hack/migrate-hierarchy.sh</code></td>
<td>Migration script for existing organizations</td>
</tr>
<tr>
<td><code>examples/organization/04-org-defaults.yaml</code></td>
<td>Example: Standalone LimitRange + HRQ reference (hybrid approach)</td>
</tr>
</tbody>
</table>
<h3 id="modified-files">Modified Files<a class="headerlink" href="#modified-files" title="Permanent link"> ¶</a></h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Change</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>internal/project/project.go</code></td>
<td>Add HierarchyConfiguration sync step after namespace creation</td>
</tr>
<tr>
<td><code>internal/organization/organization.go</code></td>
<td>Add HRQ + LimitRange + S3 quota sync steps, read plan from annotations</td>
</tr>
<tr>
<td><code>internal/controller/kube-dc.com/organization_controller.go</code></td>
<td>Watch billing annotation changes (<code>plan-id</code>, <code>addons</code>, <code>subscription</code>), trigger reconcile</td>
</tr>
<tr>
<td><code>internal/controller/kube-dc.com/eip_controller.go</code></td>
<td>Add public EIP quota check before OvnEip creation (§6.4)</td>
</tr>
<tr>
<td><code>ui/backend/controllers/billing/subscriptionController.js</code></td>
<td>Read real HRQ usage, add <code>checkout.session.completed</code> webhook handler, set <code>suspended</code> on deletion</td>
</tr>
<tr>
<td><code>ui/frontend/src/app/ManageOrganization/Billing/Billing.tsx</code></td>
<td>Show real usage, quota alerts, suspension banner</td>
</tr>
<tr>
<td><code>ui/frontend/src/app/ManageOrganization/Billing/SubscribePlanModal.tsx</code></td>
<td>Downgrade warning with current usage</td>
</tr>
<tr>
<td><code>ui/frontend/src/app/ManageOrganization/Billing/types.ts</code></td>
<td>Add quota status types</td>
</tr>
<tr>
<td><code>go.mod</code></td>
<td>Add HNC API + Rook-Ceph API dependencies</td>
</tr>
<tr>
<td><code>Makefile</code></td>
<td>Add HNC CRD generation targets</td>
</tr>
</tbody>
</table>
<h3 id="go-dependencies-to-add">Go Dependencies to Add<a class="headerlink" href="#go-dependencies-to-add" title="Permanent link"> ¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>sigs.k8s.io/hierarchical-namespaces/api v1.1.0-pfnet.10
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>github.com/rook/rook/pkg/apis                        # For CephObjectStoreUser CRD (§6.2)
</span></code></pre></div>
<hr />
<h2 id="12-monitoring-observability">12. Monitoring &amp; Observability<a class="headerlink" href="#12-monitoring-observability" title="Permanent link"> ¶</a></h2>
<h3 id="121-metrics">12.1 Metrics<a class="headerlink" href="#121-metrics" title="Permanent link"> ¶</a></h3>
<ul>
<li><code>kube_dc_hrq_usage_ratio</code> — Current usage / limit per resource type per organization</li>
<li><code>kube_dc_hrq_sync_errors</code> — Count of HRQ sync failures</li>
<li><code>kube_dc_plan_changes_total</code> — Count of plan changes (upgrade/downgrade/cancel)</li>
</ul>
<h3 id="122-alerts">12.2 Alerts<a class="headerlink" href="#122-alerts" title="Permanent link"> ¶</a></h3>
<ul>
<li>Organization usage &gt; 80% of HRQ limit → Warning notification</li>
<li>Organization usage &gt; 95% of HRQ limit → Critical notification</li>
<li>HRQ sync failure → Controller error alert</li>
<li>HNC controller down → System alert</li>
</ul>
<h3 id="123-logging">12.3 Logging<a class="headerlink" href="#123-logging" title="Permanent link"> ¶</a></h3>
<ul>
<li>HRQ create/update/delete events in organization controller</li>
<li>Quota exceeded events surfaced to UI</li>
<li>Plan change audit trail in Organization annotations (already exists via <code>billing.kube-dc.com/subscribed-at</code>)</li>
</ul>
<hr />
<h2 id="13-security-considerations">13. Security Considerations<a class="headerlink" href="#13-security-considerations" title="Permanent link"> ¶</a></h2>
<h3 id="131-authentication-layers">13.1 Authentication Layers<a class="headerlink" href="#131-authentication-layers" title="Permanent link"> ¶</a></h3>
<table>
<thead>
<tr>
<th>Entry Point</th>
<th>Authentication Method</th>
<th>Identity</th>
</tr>
</thead>
<tbody>
<tr>
<td>UI API endpoints</td>
<td>JWT token (Dex/OIDC)</td>
<td>User (org-admin or member)</td>
</tr>
<tr>
<td>Stripe webhook</td>
<td><code>Stripe-Signature</code> header verified via <code>STRIPE_WEBHOOK_SECRET</code></td>
<td>Stripe server</td>
</tr>
<tr>
<td>Go controller</td>
<td>In-cluster ServiceAccount (<code>kube-dc-manager</code>)</td>
<td>Controller process</td>
</tr>
<tr>
<td>Backend K8s calls</td>
<td>ServiceAccount token (<code>/var/run/secrets/.../token</code>)</td>
<td>Backend pod</td>
</tr>
</tbody>
</table>
<h3 id="132-rbac-separation">13.2 RBAC Separation<a class="headerlink" href="#132-rbac-separation" title="Permanent link"> ¶</a></h3>
<ul>
<li><strong>HRQ is controller-managed only:</strong> Users have no RBAC verbs on <code>hierarchicalresourcequotas</code>. Only <code>kube-dc-manager</code> SA can create/update/delete HRQ.</li>
<li><strong>Billing annotations are backend-managed:</strong> The <code>kube-dc-backend</code> SA can PATCH Organization metadata.annotations. Users cannot — their JWT-based RBAC does not include Organization write permissions on billing annotations.</li>
<li><strong>LimitRange in org namespace:</strong> org-admin users <strong>can</strong> create/update LimitRange in the org namespace (standard K8s RBAC). This is intentional — it's the "user override" path. However, they <strong>cannot</strong> modify HNC-propagated copies in project namespaces (HNC admission webhook blocks it).</li>
<li><strong>HNC hierarchy:</strong> Only <code>kube-dc-manager</code> SA can create/update <code>HierarchyConfiguration</code> objects. Users cannot re-parent namespaces.</li>
<li><strong>Admission webhooks:</strong> HNC webhook must be highly available. If webhook is down, Kubernetes API server rejects HNC resource mutations (fail-closed by default).</li>
</ul>
<h3 id="133-stripe-webhook-security">13.3 Stripe Webhook Security<a class="headerlink" href="#133-stripe-webhook-security" title="Permanent link"> ¶</a></h3>
<ul>
<li>Webhook endpoint (<code>POST /api/billing/webhook</code>) verifies every event using <code>stripe.webhooks.constructEvent(body, sig, STRIPE_WEBHOOK_SECRET)</code></li>
<li>Raw body is preserved (Express JSON parsing is skipped for this route) — required for signature verification</li>
<li><code>STRIPE_WEBHOOK_SECRET</code> is stored as a Kubernetes Secret, mounted as env var in the backend pod</li>
<li>Webhook handler uses <strong>ServiceAccount token</strong> (not user JWT) because there is no user context in server-to-server calls</li>
<li>Failed signature verification returns 400 immediately — no annotation changes</li>
</ul>
<h3 id="134-threat-mitigations">13.4 Threat Mitigations<a class="headerlink" href="#134-threat-mitigations" title="Permanent link"> ¶</a></h3>
<table>
<thead>
<tr>
<th>Threat</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td>User directly creates HRQ to get more quota</td>
<td>RBAC: no write verbs on HRQ for user roles</td>
</tr>
<tr>
<td>User patches billing annotations to fake a plan</td>
<td>RBAC: users cannot PATCH Organization annotations</td>
</tr>
<tr>
<td>Forged Stripe webhook to activate a free plan</td>
<td>Stripe signature verification rejects forged events</td>
</tr>
<tr>
<td>User deletes LimitRange in project namespace</td>
<td>HNC admission webhook blocks deletion of propagated objects</td>
</tr>
<tr>
<td>User modifies HNC hierarchy to escape quota</td>
<td>RBAC: no write verbs on HierarchyConfiguration for user roles</td>
</tr>
<tr>
<td>Backend SA token leaked</td>
<td>Limit SA scope to only Organization PATCH + HRQ read; rotate regularly</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="14-open-questions">14. Open Questions<a class="headerlink" href="#14-open-questions" title="Permanent link"> ¶</a></h2>
<ol>
<li><del><strong>Free tier limits:</strong></del> <strong>Resolved (see §7.2):</strong> Organizations without a plan get <strong>no HRQ</strong> (no enforcement). After subscription expires, HRQ transitions to a minimal "suspended" quota (0.5 CPU, 1Gi) that allows only system pods (VpcDns). After grace period, workloads are actively scaled to 0.</li>
<li><del><strong>Grace period on cancellation:</strong></del> <strong>Resolved (see §7.2):</strong> 4-phase lifecycle: <code>canceling</code> (paid period, full quota) → <code>suspended</code> (7-day grace, minimal quota) → <code>canceled</code> (workloads scaled to 0, data preserved) → cleanup (90 days, configurable).</li>
<li><del><strong>Per-project sub-quotas:</strong></del> <strong>Resolved (see §3.5):</strong> Org-admin can create standard Kubernetes <code>ResourceQuota</code> in project namespaces. Coexists with HRQ — most restrictive limit wins. No custom CRDs needed. RBAC grants org-admin <code>resourcequotas</code> write in project namespaces. UI integration optional for MVP.</li>
<li><del><strong>Object storage enforcement:</strong></del> <strong>Resolved (see §6.2):</strong> Rook-Ceph <code>CephObjectStoreUser</code> CRD has native <code>spec.quotas</code> (maxSize, maxBuckets, maxObjects). Ceph RGW enforces server-side. Same controller pattern as HRQ — plan annotation → Go controller → update CephObjectStoreUser quota. Implementation can be done alongside or after HRQ.</li>
<li><del><strong>IPv4 tracking:</strong></del> <strong>Resolved (see §6.4):</strong> Public EIPs (<code>spec.externalNetworkType: public</code>, label <code>network.kube-dc.com/external-network-type: public</code>) are quota-controlled via EIP controller-side check — count public EIPs across org's project namespaces, compare against plan's <code>ipv4</code> limit. Cloud EIPs are not counted. No custom quota resource needed — enforced in Go controller before OvnEip creation.</li>
<li><del><strong>Burst ratios:</strong></del> <strong>Resolved (see §3.6):</strong> Per-plan burst ratios: Dev Pool 3x (bursty dev workloads), Pro Pool 2x (balanced), Scale Pool 1.5x (production predictability). Configured via <code>BURST_RATIOS</code> map in planToHRQ mapping.</li>
</ol>
<hr />
<h2 id="15-references">15. References<a class="headerlink" href="#15-references" title="Permanent link"> ¶</a></h2>
<ul>
<li><a href="https://github.com/pfnet/hierarchical-namespaces">pfnet/hierarchical-namespaces</a> — Active HNC fork</li>
<li><a href="https://github.com/kubernetes-retired/hierarchical-namespaces/blob/master/docs/user-guide/concepts.md">HNC Concepts Guide</a></li>
<li><a href="https://github.com/pfnet/hierarchical-namespaces/tree/master/api/v1alpha2">HierarchicalResourceQuota API</a></li>
<li><a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">Kubernetes ResourceQuota</a></li>
<li><a href="https://stripe.com/docs/billing/subscriptions/webhooks">Stripe Billing Webhooks</a></li>
</ul>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!-- 
  Copyright and theme information
-->

<div class="md-copyright">
  <div class="md-copyright__highlight">
    Project developed by <a href="https://shalb.com" target="_blank">SHALB</a>
  </div>
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/kube-dc/kube-dc-public" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://join.slack.com/t/kube-dc/shared_invite/zt-31mr5c6ci-W3kYQ7qGDULlGQ5QJjsxmA" target="_blank" rel="noopener" title="join.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M94.1 315.1c0 25.9-21.2 47.1-47.1 47.1S0 341 0 315.1 21.2 268 47.1 268h47.1v47.1zm23.7 0c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1v117.8c0 25.9-21.2 47.1-47.1 47.1s-47.1-21.2-47.1-47.1zm47.1-189c-25.9 0-47.1-21.2-47.1-47.1s21.2-47 47.1-47S212 53.2 212 79.1v47.1h-47.1zm0 23.7c25.9 0 47.1 21.2 47.1 47.1S190.8 244 164.9 244H47.1C21.2 244 0 222.8 0 196.9s21.2-47.1 47.1-47.1zm189 47.1c0-25.9 21.2-47.1 47.1-47.1s47 21.2 47 47.1-21.2 47.1-47.1 47.1h-47.1v-47.1zm-23.7 0c0 25.9-21.2 47.1-47.1 47.1S236 222.8 236 196.9V79.1c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1zm-47.1 189c25.9 0 47.1 21.2 47.1 47.1s-21.2 47-47.1 47-47.1-21.2-47.1-47.1v-47.1h47.1zm0-23.7c-25.9 0-47.1-21.2-47.1-47.1s21.2-47.1 47.1-47.1h117.8c25.9 0 47.1 21.2 47.1 47.1s-21.2 47.1-47.1 47.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://kube-dc.com" target="_blank" rel="noopener" title="kube-dc.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "content.code.copy", "content.code.select"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>